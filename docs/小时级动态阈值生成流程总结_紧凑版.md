# åŸºäº events è¡¨çš„å°æ—¶çº§åŠ¨æ€é˜ˆå€¼ç”Ÿæˆæµç¨‹æ€»ç»“

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£è¯¦ç»†è®°å½•äº†å½“å‰å·¥ç¨‹ä¸­é€šè¿‡åˆ†æ `events` è¡¨ä¸­å†å²åŸå§‹äº¤æ˜“æ•°æ®ï¼Œå¹¶æŒ‰å°æ—¶è¿›è¡Œä¿¡æ¯æ±‡æ€»ç”Ÿæˆå‘Šè­¦é˜ˆå€¼çš„å®Œæ•´æŠ€æœ¯æµç¨‹ã€‚è¯¥ç³»ç»Ÿå®ç°äº†ä»å†å²æ•°æ®åˆ†æåˆ°å®æ—¶å‘Šè­¦çš„æ™ºèƒ½åŒ–é—­ç¯ï¼Œå…·å¤‡å°æ—¶çº§ç²¾åº¦çš„å·®å¼‚åŒ–é˜ˆå€¼ç­–ç•¥ã€‚

## ğŸ—ï¸ æ•´ä½“æ¶æ„æµç¨‹å›¾

### ç´§å‡‘ç‰ˆæµç¨‹å›¾
![workflow_compact](workflow_compact.png)

### åˆ†å±‚æ¶æ„å›¾
![workflow_layered](workflow_layered.png)

### ç®€åŒ–ç‰ˆæµç¨‹å›¾
![workflow_simple](workflow_simple.png)

## ğŸ—„ï¸ 1. æ•°æ®æ”¶é›†é˜¶æ®µ

### æ ¸å¿ƒè¡¨ç»“æ„ï¼ševents

```sql
CREATE TABLE events (
    start_time    DateTime64(3),     -- è¯·æ±‚å¼€å§‹æ—¶é—´
    end_time      DateTime64(3),     -- è¯·æ±‚ç»“æŸæ—¶é—´
    service       String,            -- æœåŠ¡å
    operation_name String,           -- æ“ä½œåç§°
    span_type     String,            -- Spanç±»å‹
    is_error      UInt8,             -- æ˜¯å¦é”™è¯¯ (0=æˆåŠŸ, 1=å¤±è´¥)
    -- å…¶ä»–å­—æ®µ...
) ENGINE = MergeTree()
ORDER BY (start_time);
```

### æ•°æ®å†™å…¥æµç¨‹

1. **æ•°æ®æº**ï¼šFlinkæ¶ˆè´¹Kafkaä¸­çš„Segmentæ•°æ®æµ
2. **åŸå§‹å­˜å‚¨**ï¼šé€šè¿‡ `EventsClickHouseSink` ç›´æ¥å†™å…¥ClickHouseçš„ `events` è¡¨
3. **æ•°æ®ç‰¹ç‚¹**ï¼šä¿å­˜å®Œæ•´çš„åŸå§‹äº¤æ˜“æ•°æ®ï¼ŒåŒ…å«è¯¦ç»†çš„è¯·æ±‚ä¿¡æ¯

## ğŸ“ˆ 2. æ•°æ®åˆ†æä¸é˜ˆå€¼ç”Ÿæˆé˜¶æ®µ

### æ ¸å¿ƒç»„ä»¶

- **ç”Ÿæˆå™¨**ï¼š`EventsBasedThresholdGenerator` - å®ç°åŸºäºåŸå§‹æ•°æ®çš„æ™ºèƒ½é˜ˆå€¼ç®—æ³•

### åˆ†æSQLæŸ¥è¯¢

```sql
SELECT 
    toHour(start_time) as hour_of_day,  -- æŒ‰å°æ—¶åˆ†ç»„ (0-23)
    service, 
    operation_name as operator_name,
    -- è®¡ç®—å“åº”æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰- ä½¿ç”¨æ­£ç¡®çš„æ—¶é—´å·®è®¡ç®—
    avg((end_time - start_time) * 1000) as avg_duration,
    max((end_time - start_time) * 1000) as max_duration,
    quantile(0.75)((end_time - start_time) * 1000) as duration_p75,
    quantile(0.90)((end_time - start_time) * 1000) as duration_p90,
    quantile(0.95)((end_time - start_time) * 1000) as duration_p95,
    quantile(0.99)((end_time - start_time) * 1000) as duration_p99,
    -- è®¡ç®—æˆåŠŸç‡å’Œé”™è¯¯ç‡
    sum(is_error) / count(*) as error_rate,
    1 - (sum(is_error) / count(*)) as success_rate,
    -- ç»Ÿè®¡ä¿¡æ¯
    count(*) as total_count,
    sum(is_error) as error_count,
    count(*) - sum(is_error) as success_count,
    -- æ ‡å‡†å·®
    stddevSamp((end_time - start_time) * 1000) as duration_std
FROM events 
WHERE start_time >= now() - INTERVAL ? DAY  -- é»˜è®¤åˆ†æå‰7å¤©
AND start_time < now() 
AND service IS NOT NULL 
AND operation_name IS NOT NULL 
AND is_error = 0  -- åªç»Ÿè®¡æˆåŠŸçš„è¯·æ±‚
AND (end_time - start_time) * 1000 < ?  -- è¿‡æ»¤å¼‚å¸¸é•¿çš„å“åº”æ—¶é—´ï¼ˆ60ç§’ï¼‰
AND (end_time - start_time) > 0  -- è¿‡æ»¤è´Ÿæ•°å“åº”æ—¶é—´
GROUP BY hour_of_day, service, operator_name 
HAVING total_count >= ?  -- ä¿è¯æ ·æœ¬å……è¶³æ€§ï¼ˆè‡³å°‘10æ¡ï¼‰
ORDER BY hour_of_day
```

### æ™ºèƒ½é˜ˆå€¼ç®—æ³•

#### ä¸‰çº§é˜ˆå€¼è®¡ç®—ç­–ç•¥

```java
// å°æ—¶çº§ç‰¹å¾è°ƒæ•´å› å­
HourlyAdjustmentFactor factor = getHourlyAdjustmentFactor(hourOfDay);

// åŸºäºåˆ†ä½æ•°è®¾ç½®é˜ˆå€¼ï¼Œæ›´åŠ ç§‘å­¦åˆç†
// LOW: åŸºäºP75ï¼Œè½»å¾®å¼‚å¸¸
// MID: åŸºäºP90ï¼Œä¸­åº¦å¼‚å¸¸  
// HIGH: åŸºäºP95ï¼Œä¸¥é‡å¼‚å¸¸
rule.avgDurationLow = max(durationP75 * factor.avgDurationFactor, avgDuration * 1.2);
rule.avgDurationMid = max(durationP90 * factor.avgDurationFactor, avgDuration * 1.5);
rule.avgDurationHigh = max(durationP95 * factor.avgDurationFactor, avgDuration * 2.0);

// æœ€å¤§å»¶è¿Ÿé˜ˆå€¼ï¼ˆåŸºäºP99å’Œæ ‡å‡†å·®ï¼‰
rule.maxDurationLow = max(durationP90 * factor.maxDurationFactor, maxDuration * 1.1);
rule.maxDurationMid = max(durationP95 * factor.maxDurationFactor, maxDuration * 1.3);
rule.maxDurationHigh = max(durationP99 * factor.maxDurationFactor, maxDuration * 1.5);

// æˆåŠŸç‡é˜ˆå€¼ï¼ˆå·²ç»è¿‡æ»¤äº†å¤±è´¥äº¤æ˜“ï¼Œè¿™é‡Œè®¾ç½®æ›´ä¸¥æ ¼çš„é˜ˆå€¼ï¼‰
rule.successRateLow = min(successRate * 0.99, 0.99);
rule.successRateMid = min(successRate * 0.97, 0.97);
rule.successRateHigh = min(successRate * 0.95, 0.95);
```

#### å°æ—¶ç‰¹å¾è¯†åˆ«

| æ—¶æ®µç±»å‹ | å°æ—¶èŒƒå›´ | é˜ˆå€¼ç­–ç•¥ | è°ƒæ•´å› å­ |
|---------|---------|---------|---------|
| **é«˜å³°æœŸ** | 9-11, 14-16, 20-22ç‚¹ | é˜ˆå€¼ç›¸å¯¹å®½æ¾ | factor > 1.0 |
| **ä½å³°æœŸ** | 0-6ç‚¹ | é˜ˆå€¼ç›¸å¯¹ä¸¥æ ¼ | factor < 1.0 |
| **å¹³å³°æœŸ** | å…¶ä»–æ—¶æ®µ | æ ‡å‡†é˜ˆå€¼ | factor = 1.0 |

#### æ•°æ®è¿‡æ»¤ç­–ç•¥

1. **æˆåŠŸè¯·æ±‚è¿‡æ»¤**ï¼š`is_error = 0` åªç»Ÿè®¡æˆåŠŸçš„è¯·æ±‚
2. **å¼‚å¸¸æ—¶é—´è¿‡æ»¤**ï¼š`(end_time - start_time) * 1000 < 60000` è¿‡æ»¤è¶…è¿‡60ç§’çš„å¼‚å¸¸è¯·æ±‚
3. **è´Ÿæ•°æ—¶é—´è¿‡æ»¤**ï¼š`(end_time - start_time) > 0` è¿‡æ»¤æ—¶é—´è®¡ç®—é”™è¯¯çš„æ•°æ®
4. **æ ·æœ¬å……è¶³æ€§**ï¼š`total_count >= 10` ç¡®ä¿æœ‰è¶³å¤Ÿçš„æ ·æœ¬è¿›è¡Œç»Ÿè®¡åˆ†æ

## ğŸ—ƒï¸ 3. è§„åˆ™å­˜å‚¨é˜¶æ®µ

### è§„åˆ™è¡¨ç»“æ„ï¼šhourly_alarm_rules

```sql
CREATE TABLE hourly_alarm_rules (
    hour_of_day UInt8,               -- å°æ—¶åºå· (0-23)
    service String,                  -- æœåŠ¡å
    operator_name String,            -- æ“ä½œå‘˜å
    operator_class String,           -- æ“ä½œå‘˜ç±»
    
    -- å¤šçº§é˜ˆå€¼ï¼ˆé«˜ä¸­ä½ä¸‰æ¡£ï¼‰
    avg_duration_low Float64,        -- å¹³å‡å»¶è¿Ÿä½é˜ˆå€¼
    avg_duration_mid Float64,        -- å¹³å‡å»¶è¿Ÿä¸­é˜ˆå€¼
    avg_duration_high Float64,       -- å¹³å‡å»¶è¿Ÿé«˜é˜ˆå€¼
    max_duration_low Float64,        -- æœ€å¤§å»¶è¿Ÿä½é˜ˆå€¼
    max_duration_mid Float64,        -- æœ€å¤§å»¶è¿Ÿä¸­é˜ˆå€¼
    max_duration_high Float64,       -- æœ€å¤§å»¶è¿Ÿé«˜é˜ˆå€¼
    success_rate_low Float64,        -- æˆåŠŸç‡ä½é˜ˆå€¼
    success_rate_mid Float64,        -- æˆåŠŸç‡ä¸­é˜ˆå€¼
    success_rate_high Float64,       -- æˆåŠŸç‡é«˜é˜ˆå€¼
    traffic_volume_low Float64,      -- äº¤æ˜“é‡ä½é˜ˆå€¼
    traffic_volume_mid Float64,      -- äº¤æ˜“é‡ä¸­é˜ˆå€¼
    traffic_volume_high Float64,     -- äº¤æ˜“é‡é«˜é˜ˆå€¼
    
    alarm_template String,           -- å‘Šè­¦æ¨¡æ¿
    analysis_days UInt8,             -- åˆ†æçš„å†å²å¤©æ•°
    sample_count UInt32,             -- æ ·æœ¬æ•°é‡
    generated_time DateTime,         -- è§„åˆ™ç”Ÿæˆæ—¶é—´
    last_updated DateTime,           -- æœ€åæ›´æ–°æ—¶é—´
    version UInt32,                  -- è§„åˆ™ç‰ˆæœ¬å·
    
    PRIMARY KEY (hour_of_day, service, operator_name)
) ENGINE = MergeTree()
ORDER BY (hour_of_day, service, operator_name);
```

## â° 4. å®šæ—¶ä¸‹å‘é˜¶æ®µ

### æ ¸å¿ƒç»„ä»¶ï¼šHourlyRulePublishProcessFunction

åŸºäºFlinkçš„ProcessFunction + Timeræœºåˆ¶å®ç°ç²¾ç¡®çš„æ•´ç‚¹è§¦å‘ã€‚

#### å·¥ä½œæµç¨‹

```java
// æ¯å°æ—¶æ•´ç‚¹è§¦å‘çš„æ ¸å¿ƒé€»è¾‘
public void onTimer(long timestamp, OnTimerContext ctx, Collector<String> out) {
    int currentHour = LocalDateTime.now().getHour();
    
    // 1. æŸ¥è¯¢å½“å‰å°æ—¶çš„æ‰€æœ‰è§„åˆ™
    Map<String, AlarmRule> ruleMap = loadHourlyRules(currentHour);
    
    // 2. æ¨é€åˆ°Kafkaå®ç°çƒ­æ›´æ–°
    publishRulesToKafka(ruleMap, currentHour);
    
    // 3. æ³¨å†Œä¸‹ä¸€ä¸ªå°æ—¶çš„å®šæ—¶å™¨
    long nextCheckTime = calculateNextCheckTime();
    ctx.timerService().registerProcessingTimeTimer(nextCheckTime);
}
```

## ğŸ”„ 5. çƒ­æ›´æ–°ä¸å®æ—¶å‘Šè­¦é˜¶æ®µ

### å¹¿æ’­æµæ¶æ„

#### Kafka Topicé…ç½®

**Topic**: `alarm_rule_topic`

**å…³é”®é…ç½®**ï¼š
```properties
# å¯ç”¨Log Compactionç­–ç•¥
cleanup.policy=compact
min.cleanable.dirty.ratio=0.1
segment.ms=60000
delete.retention.ms=86400000
partitions=1
```

### å¹¿æ’­æµå¤„ç†

#### RuleBroadcastStreamFactory

```java
// æ„å»ºè§„åˆ™å¹¿æ’­æµçš„æ ¸å¿ƒæ–¹æ³•
public static BroadcastStream<Map<String, AlarmRule>> buildRuleBroadcastStream(
        StreamExecutionEnvironment env,
        Map<String, String> kafkaConfig,
        MapStateDescriptor<String, Map<String, AlarmRule>> ruleStateDescriptor) {
    
    // ä»Kafkaæ„å»ºæ•°æ®æº
    KafkaSource<Map<String, AlarmRule>> ruleSource = KafkaSource
        .<Map<String, AlarmRule>>builder()
        .setBootstrapServers(kafkaConfig.get("bootstrap_servers"))
        .setTopics(kafkaConfig.get("alarm_rule_topic"))
        .setGroupId(kafkaConfig.get("alarm_rule_group_id"))
        .setStartingOffsets(OffsetsInitializer.earliest())
        .setDeserializer(new AlarmRuleDeserializationSchema())
        .build();
    
    // åˆ›å»ºå¹¿æ’­æµ
    return env.fromSource(ruleSource, WatermarkStrategy.noWatermarks(), "alarm-rule-source")
              .setParallelism(1)
              .filter(Objects::nonNull)
              .broadcast(ruleStateDescriptor);
}
```

## ğŸ¯ å…³é”®ç‰¹æ€§æ€»ç»“

### 1. åŸºäºåŸå§‹æ•°æ®çš„æ™ºèƒ½åŒ–é˜ˆå€¼

- **æ•°æ®æºä¼˜åŠ¿**ï¼šç›´æ¥åŸºäº `events` åŸå§‹è¡¨ï¼Œæ•°æ®æ›´å‡†ç¡®å®Œæ•´
- **ç²¾ç¡®è¿‡æ»¤**ï¼šåªç»Ÿè®¡æˆåŠŸè¯·æ±‚ï¼Œé¿å…å¤±è´¥è¯·æ±‚å¯¹é˜ˆå€¼çš„å½±å“
- **å¼‚å¸¸è¿‡æ»¤**ï¼šè¿‡æ»¤å¼‚å¸¸é•¿çš„å“åº”æ—¶é—´å’Œè´Ÿæ•°æ—¶é—´ï¼Œæé«˜æ•°æ®è´¨é‡
- **ç»Ÿè®¡å­¦åŸºç¡€**ï¼šä½¿ç”¨P75/P90/P95/P99åˆ†ä½æ•°ç¡®ä¿é˜ˆå€¼çš„ç»Ÿè®¡æ„ä¹‰

### 2. å°æ—¶çº§ç²¾åº¦

- **ä¸šåŠ¡æ„ŸçŸ¥**ï¼šè¯†åˆ«é«˜å³°æœŸã€ä½å³°æœŸã€å¹³å³°æœŸçš„ä¸åŒç‰¹å¾
- **å·®å¼‚åŒ–ç­–ç•¥**ï¼šé’ˆå¯¹ä¸åŒæ—¶æ®µé‡‡ç”¨å·®å¼‚åŒ–é˜ˆå€¼å€æ•°
- **ç²¾ç¡®è§¦å‘**ï¼šæ•´ç‚¹ä¸‹å‘å¯¹åº”æ—¶æ®µçš„ä¸“é—¨è§„åˆ™

### 3. é›¶åœæœºæ›´æ–°

- **Broadcast State**ï¼šåŸºäºFlinkå¹¿æ’­çŠ¶æ€çš„åˆ†å¸ƒå¼çƒ­æ›´æ–°
- **çŠ¶æ€ä¸€è‡´æ€§**ï¼šç¡®ä¿æ‰€æœ‰å¹¶è¡Œå®ä¾‹åŒæ­¥æ›´æ–°è§„åˆ™
- **æ— ä¸­æ–­æœåŠ¡**ï¼šè§„åˆ™æ›´æ–°è¿‡ç¨‹ä¸­å‘Šè­¦æœåŠ¡æŒç»­è¿è¡Œ

### 4. æ•°æ®å¯é æ€§

- **Log Compaction**ï¼šKafkaå‹ç¼©ç­–ç•¥ä¿è¯è§„åˆ™æ•°æ®æŒä¹…åŒ–
- **Earliestç­–ç•¥**ï¼šç¡®ä¿æ¶ˆè´¹è€…å¯åŠ¨æ—¶è·å–æœ€æ–°æœ‰æ•ˆè§„åˆ™
- **æ•…éšœæ¢å¤**ï¼šæ”¯æŒFlink checkpointå’Œè‡ªåŠ¨æ¢å¤

### 5. è¿ç»´å‹å¥½

- **å®Œæ•´æ—¥å¿—**ï¼šæ¯ä¸ªç¯èŠ‚éƒ½æœ‰è¯¦ç»†çš„ç›‘æ§æ—¥å¿—
- **çŠ¶æ€ç®¡ç†**ï¼šæ”¯æŒè§„åˆ™ç‰ˆæœ¬æ§åˆ¶å’ŒçŠ¶æ€æŸ¥è¯¢
- **å¼‚å¸¸å¤„ç†**ï¼šå®Œå–„çš„å¼‚å¸¸å¤„ç†å’Œé™çº§æœºåˆ¶

## ğŸ“Š æ€§èƒ½ä¸æ‰©å±•æ€§

### æ•°æ®é‡ä¼°ç®—

- **å†å²æ•°æ®**ï¼šåˆ†æå‰7å¤©æ•°æ®ï¼Œæ”¯æŒåƒä¸‡çº§è®°å½•æŸ¥è¯¢
- **è§„åˆ™æ•°é‡**ï¼šæ¯ä¸ªæœåŠ¡-ç®—å­ç»„åˆ24å°æ—¶è§„åˆ™ï¼Œæ”¯æŒä¸‡çº§è§„åˆ™ç®¡ç†
- **å®æ—¶å¤„ç†**ï¼šæ¯«ç§’çº§è§„åˆ™åŒ¹é…ï¼Œæ”¯æŒä¸‡çº§TPSå®æ—¶å‘Šè­¦

### æ‰©å±•èƒ½åŠ›

- **æ–°æŒ‡æ ‡æ‰©å±•**ï¼šè¡¨ç»“æ„å’Œç®—æ³•æ”¯æŒæ–°ç›‘æ§æŒ‡æ ‡
- **æ–°ç®—å­æ¥å…¥**ï¼šç»Ÿä¸€çš„ç®—å­æ³¨å†Œæœºåˆ¶
- **å¤šé›†ç¾¤éƒ¨ç½²**ï¼šæ”¯æŒå¤šæ•°æ®ä¸­å¿ƒå’Œå¤šç¯å¢ƒéƒ¨ç½²

## ğŸ”§ è¿ç»´å»ºè®®

### ç›‘æ§æŒ‡æ ‡

1. **è§„åˆ™ç”Ÿæˆç›‘æ§**ï¼šç›‘æ§æ¯æ—¥è§„åˆ™ç”ŸæˆæˆåŠŸç‡å’Œè€—æ—¶
2. **ä¸‹å‘å»¶è¿Ÿç›‘æ§**ï¼šç›‘æ§è§„åˆ™ä»ç”Ÿæˆåˆ°ç”Ÿæ•ˆçš„å»¶è¿Ÿ
3. **å‘Šè­¦å‡†ç¡®æ€§**ï¼šç›‘æ§å‘Šè­¦çš„å‡†ç¡®ç‡å’Œè¯¯æŠ¥ç‡
4. **ç³»ç»Ÿèµ„æº**ï¼šç›‘æ§ClickHouseæŸ¥è¯¢æ€§èƒ½å’ŒKafkaå»¶è¿Ÿ

### è°ƒä¼˜å»ºè®®

1. **æ ·æœ¬æ•°é‡è°ƒæ•´**ï¼šæ ¹æ®ä¸šåŠ¡é‡è°ƒæ•´æœ€å°æ ·æœ¬è¦æ±‚ï¼ˆå½“å‰10æ¡ï¼‰
2. **åˆ†æå‘¨æœŸè°ƒæ•´**ï¼šæ ¹æ®ä¸šåŠ¡ç¨³å®šæ€§è°ƒæ•´å†å²åˆ†æå¤©æ•°ï¼ˆå½“å‰7å¤©ï¼‰
3. **é˜ˆå€¼æ•æ„Ÿåº¦**ï¼šæ ¹æ®å‘Šè­¦æ•ˆæœè°ƒæ•´é˜ˆå€¼è®¡ç®—å‚æ•°
4. **å¼‚å¸¸æ—¶é—´é˜ˆå€¼**ï¼šæ ¹æ®ä¸šåŠ¡ç‰¹ç‚¹è°ƒæ•´æœ€å¤§å“åº”æ—¶é—´è¿‡æ»¤é˜ˆå€¼ï¼ˆå½“å‰60ç§’ï¼‰

---

## ğŸ“ å˜æ›´è®°å½•

| ç‰ˆæœ¬ | æ—¥æœŸ | å˜æ›´å†…å®¹ | ä½œè€… |
|------|------|----------|------|
| 1.0 | 2024-12-19 | åˆå§‹ç‰ˆæœ¬ï¼ŒåŸºäºflink_operator_agg_resultè¡¨ | AI Assistant |
| 2.0 | 2024-12-19 | æ›´æ–°ä¸ºåŸºäºeventsè¡¨çš„å®ç° | AI Assistant |

---

**æ–‡æ¡£çŠ¶æ€**ï¼šâœ… å½“å‰ç‰ˆæœ¬  
**æœ€åæ›´æ–°**ï¼š2024-12-19  
**é€‚ç”¨ç‰ˆæœ¬**ï¼šEventsBasedThresholdGenerator å®ç° 