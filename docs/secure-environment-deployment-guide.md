# 高安全隔离环境下的应用开发部署指南

## 1. 环境特征与挑战

### 1.1 环境限制
- **网络隔离**：生产环境无法访问互联网
- **数据管控**：只允许数据导入，禁止导出
- **代码安全**：生产代码不能外流
- **审计要求**：所有操作需要留痕

### 1.2 核心挑战
1. 依赖包管理困难
2. 调试和问题定位受限
3. 版本更新流程复杂
4. 开发测试环境与生产环境差异

## 2. 三环境架构设计

### 2.1 总体架构图

```
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│   开发环境       │     │   测试环境       │     │   生产环境       │
│  (可联网)       │     │  (隔离网络)     │     │  (隔离网络)     │
│                 │     │                 │     │                 │
│ • 代码开发      │     │ • 集成测试      │ ──> │ • 正式运行      │
│ • 单元测试      │     │ • 性能测试      │     │ • 监控告警      │
│ • 依赖下载      │     │ • 验收测试      │     │ • 数据处理      │
└─────────────────┘     └─────────────────┘     └─────────────────┘
        ║                       │                       ▲
        ║ 物理隔离               │ 单向连接               │
        ║                       └───────────────────────┘
        ║                              版本发布
        ╚═══════════════> 离线介质传输（U盘/光盘）
```

### 2.2 数据流向详细图

```
开发环境                    测试环境                    生产环境
┌──────────────┐          ┌──────────────┐          ┌──────────────┐
│              │          │              │          │              │
│  代码仓库     │          │  测试代码     │          │  生产代码     │
│  (GitLab)    │          │              │          │              │
│      ↓       │          │      ↓       │          │      ↓       │
│  CI/CD构建   │          │  测试部署     │          │  生产部署     │
│      ↓       │          │      ↓       │          │      ↓       │
│  制品库      │ ══USB══> │  制品库      │ ─网闸─> │  制品库      │
│              │          │              │          │              │
│  依赖下载     │ ══USB══> │  本地仓库     │          │  本地仓库     │
│  ▪ Maven     │          │  ▪ Maven     │          │  ▪ Maven     │
│  ▪ Docker    │          │  ▪ Docker    │          │  ▪ Docker    │
│  ▪ NPM       │          │  ▪ NPM       │          │  ▪ NPM       │
└──────────────┘          └──────────────┘          └──────────────┘
     ↑                                                      ↓
     └────────────────────── 禁止回流 ──────────────────────┘
```

## 3. 三环境详细搭建方案

### 3.1 网络架构设计

```
┌─────────────────────────────────────────────────────────────────────┐
│                          企业安全网络架构                              │
├─────────────────────┬─────────────────────┬────────────────────────┤
│   开发网段          │   测试网段          │   生产网段             │
│  10.1.0.0/16       │  10.2.0.0/16        │  10.3.0.0/16          │
├─────────────────────┼─────────────────────┼────────────────────────┤
│  ✓ 互联网访问       │  ✗ 无互联网访问      │  ✗ 无互联网访问        │
│  ✓ 开发/构建        │  ✓ 集成/性能测试     │  ✓ 生产运行           │
│  ✗ 无测试网连接     │  ✓ 单向访问生产      │  ✗ 完全隔离           │
└─────────────────────┴─────────────────────┴────────────────────────┘
           ║                    │                    ▲
           ║ 物理隔离            │ 单向网闸           │
           ║                    └────────────────────┘
           ║                           版本发布
           ╚═══════════> 离线介质传输（加密U盘/光盘）
```

### 3.2 安全边界设计图

```
互联网                     开发区                    隔离区
  │                         │                         │
  │    ┌──────────┐        │      ┌──────────┐      │      ┌──────────┐
  │    │  防火墙   │        │      │  网闸     │      │      │  堡垒机   │
  └───>│  (NAT)   │────────┼─────>│ (单向)    │──────┼─────>│ (4A认证) │
       └──────────┘        │      └──────────┘      │      └──────────┘
                           │                         │           │
       ┌──────────┐        │      ┌──────────┐      │           ▼
       │ 开发主机  │        │      │ 测试主机  │      │      ┌──────────┐
       │ ▪Cursor  │        │      │ ▪测试工具 │      │      │ 生产主机  │
       │ ▪Claude  │        │      │ ▪本地仓库 │      │      │ ▪应用服务 │
       └──────────┘        │      └──────────┘      │      └──────────┘
```

### 3.2 数据单向流动机制

#### 3.2.1 网络层面控制

**防火墙规则配置**：

开发环境与测试环境之间由于物理隔离，不需要配置防火墙规则。

测试环境到生产环境的规则：
- 允许测试网段（10.2.0.0/16）向生产网段（10.3.0.0/16）发起连接
- 禁止生产网段向测试网段的任何回传
- 仅开放版本发布所需的特定端口

生产环境的安全策略：
- 禁止所有出站流量
- 仅允许来自测试环境的特定入站连接
- 所有对外连接全部阻断

**网闸（GAP）部署**：

测试环境到生产环境采用硬件单向网闸，确保数据只能单向流动：

**网闸配置要求**：
- 传输方向：单向传输（测试网10.2.0.0/16 到 生产网10.3.0.0/16）
- 物理隔离：发送端和接收端物理分离，通过光纤单向传输

**允许的操作类型**：
- 监控数据查询：通过HTTPS协议（443端口）查询生产环境监控指标
- 日志收集：通过Syslog协议（514端口）收集生产环境日志信息
- 版本包传输：仅允许经过签名的版本包单向推送

**禁止的操作**：
- 文件系统访问：禁止任何形式的文件传输
- 数据库写入：禁止对生产数据库的任何修改操作
- SSH连接：禁止建立远程连接

**数据检查机制**：
- SQL语句过滤：仅允许SELECT和SHOW查询语句
- 内容审计：自动记录所有通过网闸的数据传输
- 异常检测：发现可疑操作立即告警并阻断

#### 3.2.2 开发到测试的离线传输

### 3.3 离线传输流程图

```
开发环境                    物理传输                    测试环境
────────                    ────────                    ────────

┌─────────────┐                                      ┌─────────────┐
│ 1.准备阶段   │                                      │ 4.导入阶段   │
├─────────────┤                                      ├─────────────┤
│ • 代码打包   │            ┌─────────┐              │ • 身份验证   │
│ • 镜像导出   │            │ 加密U盘  │              │ • 解密文件   │
│ • 依赖收集   │            │ ┌─────┐ │              │ • 完整性校验 │
│      ↓      │            │ │ AES │ │              │      ↓      │
├─────────────┤            │ │ 256 │ │              ├─────────────┤
│ 2.安全处理   │            │ └─────┘ │              │ 5.部署阶段   │
├─────────────┤            └─────────┘              ├─────────────┤
│ • SHA256校验 │                 ↑                   │ • 镜像加载   │
│ • AES加密    │                 │                   │ • 代码部署   │
│ • 审批记录   │     ┌──────────┴──────────┐        │ • 依赖更新   │
│      ↓      │     │                      │        │      ↓      │
├─────────────┤     │    3.物理转移         │        ├─────────────┤
│ 传输包就绪   │────>│  • 专人护送          │────────>│ 部署完成    │
└─────────────┘     │  • 签收确认          │        └─────────────┘
                    │  • 审计记录          │
                    └──────────────────────┘
```

**离线介质传输流程详细说明**：

**1. 开发环境准备传输包**：

准备工作：
- 创建带时间戳的传输目录（格式：YYYYMMDD_HHMMSS）
- 建立代码、镜像、依赖三个子目录

导出内容：
- 代码导出：使用rsync工具同步项目代码，排除.git目录和编译产物
- Docker镜像：导出应用镜像及依赖的基础镜像（MySQL、ClickHouse等）
- 依赖包：复制Maven本地仓库和NPM包缓存

安全措施：
- 生成SHA256校验文件，记录所有文件的哈希值
- 使用AES-256-CBC算法加密整个传输包
- 创建传输记录，包含日期、文件数量、大小、操作员、审批单号

**2. 物理传输过程**：
- 将加密文件写入专用加密U盘
- U盘由专人负责物理转移到测试环境
- 全程监控和记录传输过程

**3. 测试环境导入**：

验证步骤：
- 使用对应密钥解密传输包
- 校验SHA256哈希值，确保文件完整性
- 检查审批单号的有效性

导入操作：
- Docker镜像：逐个加载到本地镜像仓库
- 项目代码：同步到应用部署目录
- 依赖包：更新到本地Maven和NPM仓库
- 记录导入日志，包含时间戳和操作详情

#### 3.2.3 应用层面控制

### 3.4 版本发布流程图

```
测试环境                    版本管理系统                  生产环境
────────                    ──────────                   ────────

┌─────────────┐            ┌─────────────┐            ┌─────────────┐
│ 测试通过     │            │ 版本仓库     │            │ 生产部署     │
├─────────────┤            ├─────────────┤            ├─────────────┤
│ • 功能测试   │            │ • 版本存储   │            │ • 灰度发布   │
│ • 性能测试   │            │ • 版本签名   │            │ • 健康检查   │
│ • 安全扫描   │            │ • 审批流程   │            │ • 全量发布   │
│      ↓      │            │      ↑      │            │      ▲      │
├─────────────┤            ├──────┼──────┤            ├──────┼──────┤
│ 版本打包     │            │ 发布审批     │            │ 自动部署     │
│ • 应用包    │───────────>│ • 技术审批   │            │ • 停止旧版   │
│ • 配置文件   │   单向传输  │ • 业务审批   │<───────────│ • 启动新版   │
│ • 部署脚本   │   (网闸)   │ • 时间窗口   │   拉取版本  │ • 验证服务   │
└─────────────┘            └──────┬──────┘            └─────────────┘
                                  │
                           ┌──────▼──────┐
                           │  审计日志    │
                           │ • 操作记录   │
                           │ • 回滚点     │
                           └─────────────┘
```

**测试环境到生产环境的版本发布说明**：
创建一个Python服务类（data_transfer_service.py），实现单向数据传输功能。该类包含以下核心功能：

1. **初始化配置**：设置源目录、目标主机和目标目录，并初始化传输日志列表。

2. **文件验证功能**：
   - 检查文件扩展名是否在允许列表中（.jar、.war、.tar、.gz、.zip）
   - 验证文件大小不超过1GB限制
   - 扫描文件内容，确保不包含敏感信息（如password=或secret=等关键字）

3. **校验和计算**：使用SHA256算法计算文件的哈希值，确保传输完整性。

4. **文件传输功能**：
   - 先验证文件的合法性
   - 计算文件校验和
   - 创建包含文件名、校验和、时间戳和文件大小的传输记录
   - 使用scp命令执行单向推送（启用严格主机密钥检查）
   - 记录审计日志
   - 可选择在传输后删除源文件

### 3.3 开发环境搭建

#### 3.3.1 基础设施部署

**环境特点：**
- 网络：可访问互联网
- 用途：代码开发、单元测试、依赖下载
- 数据：使用测试数据，不含生产数据

**基础组件部署：**

1. **内网 Docker Registry：**
**内网 Docker Registry 部署步骤：**

1. **在有网环境准备镜像**：
   - 下载registry:2镜像用于搭建私有仓库
   - 下载MySQL 8.0数据库镜像
   - 下载ClickHouse 21.8版本镜像
   - 下载Confluent Kafka 7.0.0镜像

2. **导出镜像文件**：
   - 将registry镜像保存为registry.tar文件
   - 将MySQL镜像保存为mysql.tar文件
   - 将ClickHouse镜像保存为clickhouse.tar文件
   - 将Kafka镜像保存为kafka.tar文件

3. **在内网环境导入并启动**：
   - 加载registry.tar镜像文件到Docker
   - 启动Registry容器，映射5000端口，设置自动重启策略，容器名为registry

2. **内网 Maven 仓库（Nexus）：**
**内网 Maven 仓库（Nexus）部署步骤：**

1. **下载Nexus离线包**：从Sonatype官网下载Nexus 3.40.0版本的Unix安装包。

2. **配置代理仓库**：在有网络的环境中，使用Maven命令下载项目所有依赖到本地仓库，包括源代码和JavaDoc文档。

3. **打包本地仓库**：将Maven本地仓库目录（~/.m2/repository）打包成压缩文件（maven-repo.tar.gz），便于传输到内网环境。

### 3.2 离线依赖包准备

**Python 包管理：**
**Python包管理步骤：**

1. **在有网环境下载包**：使用pip download命令，根据requirements.txt文件下载所有Python包到offline-packages目录。

2. **生成依赖清单**：使用pip freeze命令生成包含确切版本号的依赖清单文件requirements-frozen.txt。

3. **在离线环境安装**：使用pip install命令，通过--no-index参数禁用在线索引，从本地offline-packages目录安装所有依赖包。

**NPM 包管理：**
**NPM包管理方案：**

1. **方案一：使用npm-offline-packager工具**
   - 全局安装npm-offline-packager工具
   - 使用npo fetch命令根据package.json文件下载所有依赖包

2. **方案二：搭建Verdaccio私有仓库**
   - 使用Docker运行Verdaccio容器，映射4873端口，作为私有NPM仓库

## 4. 代码版本管理

### 4.1 内网 GitLab 搭建

**内网GitLab搭建配置（docker-compose.yml）：**

使用Docker Compose部署GitLab社区版，配置如下：
- 使用gitlab/gitlab-ce最新版镜像
- 设置主机名为gitlab.internal
- 配置外部访问URL为http://gitlab.internal
- 将SSH端口改为2222
- 映射端口：80（HTTP）、443（HTTPS）、2222（SSH）
- 挂载卷：配置文件目录、日志目录、数据目录

### 4.2 代码迁移流程

**代码迁移流程步骤：**

1. **从外网导出代码**：使用git bundle命令创建包含所有分支和完整提交历史的bundle文件。

2. **在内网导入**：
   - 从bundle文件克隆项目到本地
   - 进入项目目录
   - 设置远程仓库地址为内网GitLab地址
   - 推送所有分支到内网GitLab
   - 推送所有标签到内网GitLab

## 5. CI/CD 流水线

### 5.1 Jenkins 离线部署

**Jenkins CI/CD流水线配置（Jenkinsfile）：**

配置声明式流水线，包含以下阶段：

1. **环境变量设置**：
   - 设置内网镜像仓库地址为registry.internal:5000
   - 根据分支名称动态设置部署环境（master分支部署到生产，其他分支部署到预发布）

2. **构建阶段**：执行Maven清理和打包，跳过测试

3. **测试阶段**：
   - 运行Maven单元测试
   - 执行SonarQube代码质量扫描

4. **安全扫描阶段**：
   - 使用OWASP依赖检查插件扫描已知漏洞
   - 使用Fortify进行代码安全扫描

5. **镜像构建阶段**：构建Docker镜像并标记版本号

6. **预发布部署阶段**：当分支为develop时，使用Ansible部署到预发布环境

7. **生产部署阶段**：当分支为master时，需要人工确认后使用Ansible部署到生产环境

### 5.2 Ansible 自动化部署

**Ansible自动化部署配置（deploy.yml）：**

定义Ansible剧本，针对app_servers主机组执行以下任务：

1. **变量定义**：
   - 应用名称：segment-alarm-clickhouse
   - 部署用户：deploy
   - 部署路径：/opt/apps/应用名称

2. **部署任务**：
   - 创建部署目录，设置目录权限归属deploy用户
   - 复制编译好的jar包到部署目录
   - 使用模板渲染配置文件application.yml
   - 创建systemd服务配置文件
   - 启动应用服务，设置开机自启动，并重新加载systemd配置

## 6. 应用部署流程

### 6.1 部署包准备

创建自包含的部署包结构：
```
deployment-package/
├── bin/
│   ├── start.sh              # 应用启动脚本
│   ├── stop.sh               # 应用停止脚本
│   └── health-check.sh       # 健康检查脚本
├── lib/
│   └── app.jar               # 主应用程序JAR包
├── config/
│   ├── application.yml       # 应用配置文件
│   └── logback.xml          # 日志配置文件
├── scripts/
│   ├── install.sh           # 首次安装脚本
│   ├── upgrade.sh           # 版本升级脚本
│   └── rollback.sh          # 版本回滚脚本
├── sql/
│   ├── schema.sql           # 数据库表结构
│   └── init-data.sql        # 初始化数据
└── docs/
    ├── deployment-guide.md   # 部署指南
    └── troubleshooting.md    # 故障排查手册
```

### 6.2 数据库版本管理

使用 Flyway 进行数据库版本控制：
**数据库版本管理脚本（使用Flyway）：**

1. **V1__Create_events_table.sql**：
   - 创建events表，包含以下字段：
     - id（字符串类型）
     - trace_id（字符串类型）
     - service（字符串类型）
     - operation（字符串类型）
     - start_time（日期时间类型）
     - end_time（日期时间类型）
     - duration（无符号64位整数）
     - status_code（无符号16位整数）
   - 使用MergeTree引擎，按service和start_time排序

2. **V2__Add_index.sql**：
   - 为events表的trace_id字段添加布隆过滤器索引，粒度为4

### 6.3 配置管理

**环境配置分离：**
**环境配置分离方案（application.yml）：**

1. **主配置文件**：
   - 设置活动配置文件，默认使用dev，可通过DEPLOY_ENV环境变量覆盖

2. **开发环境配置（application-dev.yml）**：
   - 数据库连接指向本地MySQL，端口3306，数据库名dev

3. **生产环境配置（application-prod.yml）**：
   - 数据库连接指向生产数据库服务器prod-db，端口3306，数据库名prod

4. **敏感信息管理**：
   - 数据库密码通过DB_PASSWORD环境变量注入，避免硬编码

## 7. 监控和日志

### 7.1 离线监控方案

**离线监控方案配置（prometheus.yml）：**

配置Prometheus监控系统：
- 全局配置：设置抓取间隔为15秒
- 应用指标监控：配置job名称为app-metrics，监控app1和app2的8080端口，指标路径为/actuator/prometheus
- 节点监控：配置job名称为node-exporter，监控node1和node2的9100端口

### 7.2 集中式日志

**集中式日志配置（filebeat.yml）：**

配置Filebeat日志收集器：
- 输入配置：启用日志类型输入，监控/var/log/apps/目录下所有.log文件
- 多行日志处理：使用正则表达式匹配日期格式（YYYY-MM-DD）作为日志开始标记
- 输出配置：发送到内网Elasticsearch（elasticsearch.internal:9200），索引按日期分片（app-logs-YYYY.MM.DD）

## 8. 故障处理流程

### 8.1 日志导出方案

由于不能直接导出，采用以下策略：
1. **脱敏处理**：开发日志脱敏工具
2. **摘要生成**：生成问题摘要报告
3. **模拟重现**：在测试环境重现问题

**日志脱敏脚本（log-sanitizer.sh）：**

创建bash脚本实现日志脱敏功能：
1. **IP地址脱敏**：使用sed命令将所有IP地址（格式：xxx.xxx.xxx.xxx）替换为xxx.xxx.xxx.xxx
2. **身份证号脱敏**：将15-18位数字替换为星号（****************）
3. **手机号脱敏**：将手机号（1开头的11位数字）替换为138****0000格式

### 8.2 远程协助方案

1. **屏幕共享**：使用内网 VNC 或 TeamViewer
2. **问题模板**：标准化问题描述模板
3. **知识库**：建立内部问题解决知识库

## 9. 最佳实践

### 9.1 开发规范

1. **依赖管理**
   - 明确声明所有依赖版本
   - 定期更新依赖安全补丁
   - 使用依赖检查工具

2. **代码规范**
   - 完善的错误处理
   - 详细的日志记录
   - 配置外部化

3. **文档规范**
   - 部署文档必须详尽
   - 包含常见问题解决方案
   - 版本更新说明

### 9.2 安全要求

1. **代码安全**
   **代码安全实践（Java示例）：**
   
   - **避免硬编码敏感信息**：使用@Value注解从配置文件读取密钥，密钥值通过${app.secret-key}引用
   - **使用加密存储**：创建TextEncryptor Bean，使用Spring Security的Encryptors工具类，通过密码和盐值创建文本加密器

2. **通信安全**
   - 内网也要使用 HTTPS
   - API 认证和授权
   - 审计日志记录

### 9.3 应急预案

1. **回滚机制**
   **回滚机制脚本：**
   
   1. **版本清理**：使用ls命令列出/opt/apps/releases/目录下的所有版本，保留最新的3个版本，删除旧版本
   2. **快速回滚**：通过软链接方式，将/opt/apps/current指向指定版本（如v1.2.3），然后重启应用服务

2. **灾备方案**
   - 定期备份配置和数据
   - 双机热备部署
   - 降级方案准备

## 10. 工具清单

### 必备离线工具包
- JDK 8/11/17
- Maven 3.8+
- Git 2.30+
- Docker 20.10+
- Ansible 2.10+
- Jenkins 2.350+
- SonarQube 9.0+
- Nexus 3.40+
- GitLab 14.0+
- Prometheus + Grafana
- ELK Stack

### 开发辅助工具
- Arthas（Java诊断）
- JProfiler（性能分析）
- Wireshark（网络分析）
- Postman（API测试）

通过这套完整的流程和工具，可以在高安全隔离环境中顺利进行应用的开发、测试、部署和运维。

## 10. 应用部署架构图

### 10.1 生产环境高可用部署架构

```
                        用户请求
                           │
                    ┌──────▼──────┐
                    │   负载均衡    │
                    │  (F5/Nginx)  │
                    └──────┬──────┘
                           │
        ┌──────────────────┼──────────────────┐
        │                  │                  │
┌───────▼──────┐   ┌───────▼──────┐   ┌───────▼──────┐
│   应用节点1   │   │   应用节点2   │   │   应用节点3   │
│  ▪Spring Boot│   │  ▪Spring Boot│   │  ▪Spring Boot│
│  ▪Flink Job  │   │  ▪Flink Job  │   │  ▪Flink Job  │
└───────┬──────┘   └───────┬──────┘   └───────┬──────┘
        │                  │                  │
        └──────────────────┼──────────────────┘
                           │
        ┌──────────────────┼──────────────────┐
        │                  │                  │
┌───────▼──────┐   ┌───────▼──────┐   ┌───────▼──────┐
│   Kafka集群   │   │  ClickHouse  │   │   Redis集群   │
│   (3 Broker) │   │   集群(3节点) │   │  (3主3从)     │
└──────────────┘   └──────────────┘   └──────────────┘
```

### 10.2 监控告警架构

```
┌─────────────────────────────────────────────────────────┐
│                    监控数据流                            │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  应用层        中间件层         数据层         告警层    │
│    │             │              │              │        │
│    ▼             ▼              ▼              ▼        │
│ ┌──────┐    ┌──────┐      ┌──────┐      ┌──────────┐ │
│ │Metrics│    │ Logs │      │Traces│      │AlertManager│ │
│ └───┬──┘    └───┬──┘      └───┬──┘      └─────▲────┘ │
│     │           │              │                │       │
│     └───────────┴──────────────┴────────────────┘      │
│                 │                                       │
│                 ▼                                       │
│         ┌──────────────┐                               │
│         │  Prometheus  │───────────────────────────────┤
│         └──────┬───────┘                               │
│                │                                        │
│                ▼                                        │
│         ┌──────────────┐     ┌──────────────┐         │
│         │   Grafana    │     │   AI分析引擎  │         │
│         │  (可视化)    │     │  (异常检测)   │         │
│         └──────────────┘     └──────────────┘         │
└─────────────────────────────────────────────────────────┘
```

## 11. 测试环境搭建

### 11.1 环境特点与要求

**环境特征：**
- 网络：内网隔离，不能访问互联网
- 用途：集成测试、性能测试、验收测试
- 数据：测试数据 + 可查询的生产监控数据
- 规模：与生产环境1:1或1:2
- 连接：与开发环境物理隔离，可单向访问生产环境

**安全要求：**
- 通过离线介质从开发环境接收代码和镜像
- 不能向开发环境传输任何数据
- 只能单向查询生产环境的监控数据
- 禁止修改生产环境任何数据

### 11.2 基础设施部署

#### 11.2.1 环境初始化

**环境初始化步骤：**

1. **服务器准备（最小化配置）**：
   - 应用服务器：4台（2主2备）
   - 数据库服务器：2台（主从架构）
   - 中间件服务器：2台（部署Kafka、Redis）
   - 监控服务器：1台

2. **网络配置**：
   - 配置内网DNS服务器，主DNS为10.2.1.10，备DNS为10.2.1.11
   - 设置搜索域为pre-prod.internal

3. **时间同步（内网NTP）**：
   - 配置chrony时间同步服务
   - 指定内网NTP服务器：ntp1.pre-prod.internal和ntp2.pre-prod.internal
   - 启用快速同步和硬件时钟同步

#### 11.2.2 离线软件包部署

**离线软件包部署脚本（import_from_media.sh）：**

1. **从离线介质导入软件包**：
   - 设置USB介质路径和导入目录（包含日期戳）
   - 检查离线介质是否存在
   - 创建导入目录
   - 复制加密的软件包和校验和文件
   - 使用OpenSSL解密软件包（AES-256-CBC算法）
   - 验证SHA256校验和

2. **在测试环境解压部署**：
   - 切换到/data/incoming目录
   - 再次验证校验和
   - 解压软件包

3. **加载Docker镜像**：
   - 遍历docker-images目录下的所有tar文件
   - 使用docker load命令逐个加载镜像

4. **配置本地YUM源**：
   - 使用createrepo创建本地软件包仓库
   - 配置YUM源文件，指向本地文件路径
   - 禁用GPG检查

### 11.3 应用部署配置

#### 11.3.1 数据库环境

**数据库环境配置SQL：**

1. **创建测试数据库**：创建名为test_o11y的测试数据库

2. **创建测试数据表**：
   - 复制生产环境的events表结构到test_events
   - 复制生产环境的metrics表结构到test_metrics

3. **创建生产数据只读视图**：
   - 创建prod_monitoring_view视图，通过网闸访问生产集群
   - 查询最近1小时的数据
   - 按服务和分钟聚合，统计请求数、平均响应时间和最大响应时间

4. **创建测试账号**：
   - 创建test_user用户，限制访问来源为10.2.%网段
   - 授予测试数据库的全部权限
   - 授予生产监控视图的只读权限

#### 11.3.2 应用配置

**应用配置文件（application-test.yml）：**

配置测试环境的Spring Boot应用：

1. **数据源配置**：
   - 测试数据库：连接ClickHouse 10.2.1.20:8123/test_o11y，使用test_user用户，密码通过TEST_DB_PASSWORD环境变量注入
   - 生产只读连接：通过网闸连接生产ClickHouse 10.3.1.20:8123/prod_o11y，使用readonly_user，设置为只读模式

2. **Kafka配置**：连接内网Kafka集群（10.2.1.30:9092和10.2.1.31:9092）

3. **监控配置**：
   - 设置为测试模式
   - 启用生产数据只读访问
   - 仅允许SELECT和SHOW操作

4. **安全审计**：启用详细级别的审计日志

5. **性能测试场景**：
   - 正常负载：1000 TPS，持续300秒
   - 峰值负载：5000 TPS，持续60秒

### 11.4 测试环境访问生产数据

#### 11.4.1 单向查询服务

**单向查询服务（ProductionMonitoringService.java）：**

创建Java服务类，实现测试环境访问生产数据：

1. **类配置**：
   - 使用@Component和@Profile("test")注解，仅在测试环境激活
   - 注入生产环境只读数据源

2. **查询生产环境监控数据方法**：
   - 构建SQL查询，统计服务请求数、平均响应时间和P99响应时间
   - 设置数据库连接为只读事务，使用READ_COMMITTED隔离级别
   - 参数化查询，按服务名和时间范围过滤
   - 将结果映射为ServiceMetrics对象列表
   - 异常处理：仅记录错误日志，不向生产环境写入任何数据

3. **性能对比方法**：
   - 获取测试环境指标数据
   - 获取生产环境最近1小时的指标数据（只读）
   - 生成性能对比报告，包含服务名、测试指标、生产指标和分析结果

### 11.5 测试数据管理

#### 11.5.1 数据生成器

**测试数据生成器（TestDataGenerator.java）：**

创建Java组件生成测试数据：

1. **类配置**：使用@Component和@Profile("test")注解，仅在测试环境激活

2. **定时生成测试数据**：
   - 使用@Scheduled注解，每秒执行一次
   - 构建TraceData对象：
     - 生成随机UUID作为traceId
     - 服务名为test-service-加随机数字（0-9）
     - 操作名为test-operation-加随机数字（0-19）
     - 随机响应时间（0-999毫秒）
     - 当前时间戳
   - 发送到Kafka的traces主题

3. **性能测试数据生成**：
   - 接受TPS（每秒事务数）和持续时间参数
   - 创建10个线程的线程池
   - 计算结束时间
   - 循环执行直到达到结束时间：
     - 每秒提交TPS个数的任务到线程池
     - 线程睡眠1秒后继续

## 12. 生产环境搭建

### 12.1 环境特点与要求

**环境特征：**
- 网络：完全隔离，物理隔离或网闸隔离
- 安全：最高级别安全防护
- 数据：真实生产数据，严禁外泄
- 可用性：99.99%高可用要求

**访问控制：**
- 堡垒机访问
- 多因素认证
- 操作审计录屏
- 最小权限原则

### 12.2 安全加固部署

#### 12.2.1 操作系统加固

**操作系统安全加固脚本（security_baseline.sh）：**

1. **安全基线配置**：
   - 禁用不必要的服务：postfix邮件服务、bluetooth蓝牙服务
   - 优化内核参数：
     - 启用SYN Cookie防护
     - 启用反向路径过滤
     - 忽略ICMP广播请求
     - 禁用源路由
     - 禁用ICMP重定向
   - 防止SYN攻击设置：
     - SYN队列最大值设置为4096
     - SYNACK重试次数设置为2
     - SYN重试次数设置为2
   - 文件句柄限制设置为65535

2. **账号安全配置**：
   - 密码策略设置：
     - 最小长度12位
     - 必须包含至少1个数字
     - 必须包含至少1个大写字母
     - 必须包含至少1个特殊字符
     - 必须包含至少1个小写字母
   - 限制su命令：仅允许wheel组成员使用su命令

3. **审计配置**：
   - 监控敏感文件变更：/etc/passwd、/etc/shadow、/etc/sudoers
   - 监控网络连接：记录所有connect系统调用
   - 监控命令执行：记录所有execve系统调用

#### 12.2.2 应用安全部署

**应用安全部署配置（docker-compose-prod.yml）：**

使用Docker Compose 3.8版本配置生产环境：

1. **应用服务配置**：
   - 镜像：从内网生产仓库拉取，使用VERSION环境变量指定版本
   - 部署配置：
     - 副本数：3个
     - 资源限制：最大CPU 2核、内存4GB
     - 资源预留：最少CPU 1核、内存2GB

2. **安全配置**：
   - 禁止提权：no-new-privileges:true
   - Seccomp配置：unconfined
   - 只读文件系统
   - tmpfs挂载/tmp和/var/run目录

3. **环境变量**：
   - JVM参数：最大最小堆内存3GB，使用G1GC
   - Spring配置文件：激活prod配置

4. **敏感信息管理**：
   - 使用Docker Secrets管理数据库密码和API密钥

5. **网络配置**：
   - 使用overlay驱动
   - 启用网络加密

### 12.3 数据保护机制

#### 12.3.1 数据库安全

**数据库安全配置SQL：**

1. **创建加密表空间**：
   - 创建名为encrypted_ts的加密表空间
   - 数据文件路径：/secure/mysql/encrypted01.ibd
   - 启用加密选项

2. **敏感数据加密存储**：
   - 创建sensitive_data表
   - 字段：id（BIGINT主键）、data（VARBINARY 255字节）
   - 为data字段创建索引
   - 使用加密表空间
   - 启用表级加密

3. **数据访问审计**：
   - 安装audit_log审计插件
   - 配置审计用户：监控app_user和admin_user的所有访问
   - 设置审计策略为ALL，记录所有操作

#### 12.3.2 数据防泄露

**数据防泄露服务（data_protection_service.py）：**

创建Python类实现数据保护功能：

1. **初始化配置**：
   - 定义敏感数据正则表达式模式：
     - 身份证号：15-18位数字
     - 手机号：1开头的11位数字
     - 银行卡号：16-19位数字
     - 邮箱地址：标准邮箱格式
   - 从安全路径/secure/keys/master.key加载加密密钥

2. **数据脱敏方法**：
   - 身份证：保留前6位和后4位，中间8位用星号替换
   - 手机号：保留前3位和后4位，中间4位用星号替换
   - 银行卡：保留前4位和后4位，中间8位用星号替换
   - 邮箱：保留用户名前3位，中间用***替换，保留完整域名

3. **字段级加密方法**：
   - 使用Fernet对称加密算法
   - 将数据编码后加密，返回加密后的字符串

4. **防止批量导出方法**：
   - 设置最大导出行数限制为1000行
   - 超过限制时记录警告日志并抛出权限错误
   - 检查结果集中是否包含敏感字段（password、secret、token、key）
   - 发现敏感字段时记录错误日志并拒绝导出

### 12.4 运维管理

#### 12.4.1 堡垒机配置

**堡垒机配置（jumpserver配置）：**

1. **资产配置**：
   - 服务器名称：prod-app-01
   - IP地址：10.3.1.10
   - SSH端口：22
   - 平台：Linux
   - 支持协议：SSH
   - 权限分配：
     - 运维团队：允许连接和上传文件
     - 开发团队：仅允许连接

2. **会话录制**：
   - 录像保留90天
   - 实时上传录像文件

3. **命令过滤**：
   - 危险命令黑名单：rm -rf、mkfs、dd if=、shutdown、reboot
   - 操作：拒绝执行

4. **文件传输控制**：
   - 上传：启用，最大100MB，仅允许.tar、.gz、.zip、.jar文件
   - 下载：禁止

#### 12.4.2 监控告警

**监控告警规则配置（prometheus-rules.yml）：**

定义生产环境告警规则组，每30秒评估一次：

1. **数据泄露检测规则**：
   - 告警名称：PossibleDataLeak
   - 触发条件：5分钟内HTTP响应数据量速率超过10MB
   - 持续时间：1分钟
   - 严重级别：critical
   - 告警信息：包含实例名称和异常描述

2. **异常访问检测规则**：
   - 告警名称：AbnormalAccess
   - 触发条件：5分钟内失败登录尝试速率超过10次
   - 持续时间：1分钟
   - 严重级别：warning
   - 告警描述：检测到异常访问尝试

3. **敏感操作告警规则**：
   - 告警名称：SensitiveOperation
   - 触发条件：敏感操作计数器大于0
   - 严重级别：info
   - 告警描述：显示具体的敏感操作名称

## 13. 数据单向流动保障措施

### 13.1 技术措施

1. **网络隔离**
   - 物理隔离：不同环境使用独立网络设备
   - VLAN隔离：逻辑隔离不同环境
   - 防火墙规则：严格的访问控制列表

2. **应用层控制**
   - API网关：统一的访问入口，只允许特定方向的请求
   - 消息队列：单向Topic，只允许写入不允许读取
   - 数据库：只读副本，不允许写回

3. **存储层保护**
   - 只读挂载：生产数据目录只读挂载到其他环境
   - 快照备份：定期快照，不允许直接访问
   - 加密存储：敏感数据加密，密钥隔离管理

### 13.2 管理措施

1. **流程控制**
   - 数据流转审批流程
   - 定期安全审计
   - 违规操作处罚机制

2. **人员管理**
   - 最小权限原则
   - 定期权限审查
   - 安全意识培训

3. **审计追踪**
   - 全量操作日志
   - 数据访问审计
   - 定期合规检查

通过以上完整的三环境架构和严格的单向数据流控制，可以确保生产数据的绝对安全，同时保证开发和测试的正常进行。

## 14. 架构特点总结

### 14.1 三环境隔离模式

| 环境 | 网络状态 | 数据流向 | 主要用途 |
|------|---------|---------|---------|
| 开发环境 | ✓ 可联网 | → 离线介质 → 测试环境 | 代码开发、依赖下载 |
| 测试环境 | ✗ 内网隔离 | → 版本发布 → 生产环境 | 集成测试、版本验证 |
| 生产环境 | ✗ 完全隔离 | ✗ 只进不出 | 业务运行、数据处理 |

### 14.2 数据流向控制

1. **开发 → 测试**：
   - 物理隔离，无网络连接
   - 通过加密U盘/光盘传输
   - 需要审批和审计

2. **测试 → 生产**：
   - 通过版本管理系统发布
   - 版本包单向传输
   - 严格的发布审批流程
   - 自动化部署和回滚

3. **生产 → 外部**：
   - 完全禁止
   - 数据只进不出
   - 多层防护机制

### 14.3 安全保障措施

**技术层面**：
- 网络物理隔离
- 单向网闸
- 数据加密传输
- 访问控制列表

**管理层面**：
- 严格审批流程
- 操作审计记录
- 定期安全检查
- 人员权限管理

### 14.4 实施建议

1. **先建设测试环境**：作为开发和生产的缓冲区
2. **逐步完善隔离**：从逻辑隔离到物理隔离
3. **建立应急机制**：预案和快速响应
4. **持续优化流程**：平衡安全与效率

这种架构特别适合对数据安全要求极高的场景，如金融、政府、军工等领域。虽然增加了开发部署的复杂度，但能够最大程度保证生产数据的安全性。

## 15. 附加架构图示

### 15.1 AI辅助开发工作流图

```
┌─────────────────────────────────────────────────────────────────┐
│                    AI原生开发模式工作流                            │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  开发者                   AI助手                    代码仓库      │
│    │                       │                         │          │
│    ├──需求描述──────────────>│                         │          │
│    │                       ├─理解需求                  │          │
│    │                       ├─生成代码                  │          │
│    │<─────代码建议──────────┤                         │          │
│    │                       │                         │          │
│    ├──修改/优化─────────────>│                         │          │
│    │                       ├─代码优化                  │          │
│    │                       ├─错误修复                  │          │
│    │<─────优化后代码─────────┤                         │          │
│    │                       │                         │          │
│    ├──测试运行──────────────>│                         │          │
│    │                       ├─分析结果                  │          │
│    │                       ├─建议改进                  │          │
│    │<─────测试报告──────────┤                         │          │
│    │                       │                         │          │
│    └──提交代码───────────────────────────────────────────>│          │
│                                                         │          │
└─────────────────────────────────────────────────────────────────┘
```

### 15.2 离线软件包管理架构

```
                    离线软件包管理系统架构
┌─────────────────────────────────────────────────────────────┐
│                        有网环境                              │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐    │
│  │  Maven中央库  │  │  Docker Hub  │  │   NPM官方库   │    │
│  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘    │
│         │                  │                  │             │
│         ▼                  ▼                  ▼             │
│  ┌─────────────────────────────────────────────────┐       │
│  │              同步下载服务器                       │       │
│  │  • 定时同步任务     • 增量更新                   │       │
│  │  • 版本管理        • 依赖分析                   │       │
│  └─────────────┬───────────────────────────────────┘       │
│                │                                            │
└────────────────┼────────────────────────────────────────────┘
                 │ 离线传输
        ┌────────▼────────┐
        │   传输介质       │
        │  • 加密U盘      │
        │  • 光盘         │
        │  • 移动硬盘     │
        └────────┬────────┘
                 │
┌────────────────┼────────────────────────────────────────────┐
│                │              内网环境                       │
│       ┌────────▼────────┐                                  │
│       │   导入验证       │                                  │
│       │  • 完整性校验   │                                  │
│       │  • 签名验证     │                                  │
│       └────────┬────────┘                                  │
│                │                                            │
│  ┌─────────────▼────────┐  ┌─────────────┐  ┌────────────┐│
│  │   Nexus私服          │  │Harbor镜像库  │  │Verdaccio   ││
│  │  (Maven/Gradle)      │  │  (Docker)    │  │  (NPM)     ││
│  └──────────────────────┘  └─────────────┘  └────────────┘│
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 15.3 安全审计与合规架构

```
┌─────────────────────────────────────────────────────────────────┐
│                      安全审计与合规体系                           │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   数据流审计                操作审计               合规检查      │
│  ┌──────────┐            ┌──────────┐          ┌──────────┐   │
│  │ 网络流量  │            │ 用户操作  │          │ 安全基线  │   │
│  │  • DPI   │            │ • 命令    │          │ • CIS    │   │
│  │  • 协议  │            │ • 文件    │          │ • 等保   │   │
│  └─────┬────┘            └─────┬────┘          └─────┬────┘   │
│        │                       │                      │         │
│        └───────────┬───────────┘                      │         │
│                    ▼                                  │         │
│           ┌────────────────┐                         │         │
│           │   审计日志中心  │<────────────────────────┘         │
│           │  • 集中存储    │                                   │
│           │  • 实时分析    │                                   │
│           │  • 告警通知    │                                   │
│           └────────┬───────┘                                   │
│                    │                                            │
│    ┌───────────────┼───────────────┐                          │
│    ▼               ▼               ▼                          │
│ ┌──────┐      ┌──────┐      ┌──────────┐                    │
│ │ SIEM │      │ 报表 │      │ 归档存储  │                    │
│ │ 平台 │      │ 系统 │      │ (7年)    │                    │
│ └──────┘      └──────┘      └──────────┘                    │
└─────────────────────────────────────────────────────────────────┘
```

### 15.4 容灾备份架构

```
                        双活数据中心架构
┌───────────────────────────┐     ┌───────────────────────────┐
│      主数据中心 (DC1)      │     │      备数据中心 (DC2)      │
├───────────────────────────┤     ├───────────────────────────┤
│                           │     │                           │
│  ┌─────────┐ ┌─────────┐ │     │ ┌─────────┐ ┌─────────┐ │
│  │ 应用集群 │ │ 应用集群 │ │     │ │ 应用集群 │ │ 应用集群 │ │
│  │  (主)   │ │  (主)   │ │     │ │  (备)   │ │  (备)   │ │
│  └────┬────┘ └────┬────┘ │     │ └────┬────┘ └────┬────┘ │
│       │           │       │     │      │           │       │
│       └─────┬─────┘       │     │      └─────┬─────┘       │
│             │             │     │            │             │
│      ┌──────▼──────┐      │     │     ┌──────▼──────┐      │
│      │  负载均衡器  │      │     │     │  负载均衡器  │      │
│      │   (Active)  │      │     │     │  (Standby)  │      │
│      └──────┬──────┘      │     │     └──────┬──────┘      │
│             │             │     │            │             │
│      ┌──────▼──────┐      │     │     ┌──────▼──────┐      │
│      │   数据库    │◄─────┼─────┼────►│   数据库    │      │
│      │  (Master)   │      │     │     │  (Slave)    │      │
│      └─────────────┘      │     │     └─────────────┘      │
│                           │     │                           │
│      ┌─────────────┐      │     │     ┌─────────────┐      │
│      │  存储系统   │◄─────┼─────┼────►│  存储系统   │      │
│      │  (Primary)  │      │同步 │     │ (Secondary) │      │
│      └─────────────┘      │复制 │     └─────────────┘      │
└───────────────────────────┘     └───────────────────────────┘
                    │                           │
                    └───────────┬───────────────┘
                                │
                        ┌───────▼───────┐
                        │   DNS智能解析  │
                        │  (故障切换)   │
                        └───────────────┘
```

### 15.5 性能监控仪表板布局

```
┌─────────────────────────────────────────────────────────────────┐
│                    生产环境监控大屏                              │
├─────────────────────────────────────────────────────────────────┤
│ ┌──────────────────┐ ┌──────────────────┐ ┌──────────────────┐ │
│ │   系统总览        │ │   实时告警        │ │   服务健康度      │ │
│ │ • CPU: 45%       │ │ • Critical: 0     │ │ • API: 99.99%    │ │
│ │ • 内存: 62%      │ │ • Warning: 2      │ │ • DB: 99.98%     │ │
│ │ • 磁盘: 38%      │ │ • Info: 15        │ │ • MQ: 100%       │ │
│ └──────────────────┘ └──────────────────┘ └──────────────────┘ │
│                                                                 │
│ ┌───────────────────────────────────────────────────────────┐ │
│ │                    请求量趋势图 (24小时)                    │ │
│ │  10K ┤                                    ╱╲               │ │
│ │   8K ┤                                   ╱  ╲              │ │
│ │   6K ┤                   ╱╲            ╱    ╲             │ │
│ │   4K ┤    ╱╲           ╱  ╲         ╱      ╲            │ │
│ │   2K ┤───╱  ╲─────────╱    ╲───────╱        ╲───────    │ │
│ │      └────┴────┴────┴────┴────┴────┴────┴────┴────┴────   │ │
│ │      00:00 04:00 08:00 12:00 16:00 20:00 24:00           │ │
│ └───────────────────────────────────────────────────────────┘ │
│                                                                 │
│ ┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐ │
│ │  响应时间分布    │ │   错误率统计     │ │   资源使用TOP5   │ │
│ │ • P50: 45ms     │ │ • 4xx: 0.01%    │ │ 1. Service-A 85% │ │
│ │ • P90: 120ms    │ │ • 5xx: 0.001%   │ │ 2. Service-B 72% │ │
│ │ • P99: 350ms    │ │ • 总计: 0.011%  │ │ 3. Service-C 68% │ │
│ └─────────────────┘ └─────────────────┘ └─────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
```

### 15.6 DevOps工具链集成图

```
                        DevOps 工具链全景图
┌─────────────────────────────────────────────────────────────────┐
│                                                                 │
│   规划          开发           构建          测试         部署    │
│     │            │             │             │            │     │
│  ┌──▼──┐    ┌───▼───┐    ┌───▼───┐    ┌───▼───┐    ┌───▼───┐│
│  │Jira │    │Cursor │    │Jenkins│    │JMeter │    │Ansible││
│  │     │───►│Claude │───►│       │───►│Selenium│───►│       ││
│  └─────┘    └───┬───┘    └───┬───┘    └───┬───┘    └───┬───┘│
│                 │             │             │             │     │
│            ┌────▼────┐   ┌───▼───┐    ┌───▼───┐    ┌───▼───┐│
│            │GitLab   │   │Maven  │    │SonarQube   │K8s    ││
│            │         │   │Docker │    │         │   │       ││
│            └─────────┘   └───────┘    └─────────┘   └───────┘│
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐  │
│  │                     监控与反馈                            │  │
│  │  Prometheus  │  Grafana  │  ELK Stack  │  PagerDuty    │  │
│  └─────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
```

### 15.7 数据安全分层防护模型

```
┌─────────────────────────────────────────────────────────────────┐
│                    数据安全分层防护架构                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  第7层  ┌─────────────────────────────────────────────────┐   │
│  合规层  │  等保三级 │ ISO27001 │ 数据分类分级 │ 隐私保护   │   │
│         └─────────────────────────────────────────────────┘   │
│                                                                 │
│  第6层  ┌─────────────────────────────────────────────────┐   │
│  审计层  │  操作审计 │ 数据访问审计 │ 异常行为检测 │ 日志归档 │   │
│         └─────────────────────────────────────────────────┘   │
│                                                                 │
│  第5层  ┌─────────────────────────────────────────────────┐   │
│  应用层  │  数据脱敏 │ 字段加密 │ 访问控制 │ API安全       │   │
│         └─────────────────────────────────────────────────┘   │
│                                                                 │
│  第4层  ┌─────────────────────────────────────────────────┐   │
│  数据层  │  透明加密 │ 备份加密 │ 密钥管理 │ 数据分片      │   │
│         └─────────────────────────────────────────────────┘   │
│                                                                 │
│  第3层  ┌─────────────────────────────────────────────────┐   │
│  主机层  │  系统加固 │ 补丁管理 │ 防病毒 │ 完整性监控      │   │
│         └─────────────────────────────────────────────────┘   │
│                                                                 │
│  第2层  ┌─────────────────────────────────────────────────┐   │
│  网络层  │  防火墙 │ IDS/IPS │ 网闸 │ VPN加密            │   │
│         └─────────────────────────────────────────────────┘   │
│                                                                 │
│  第1层  ┌─────────────────────────────────────────────────┐   │
│  物理层  │  机房安全 │ 设备安全 │ 介质管理 │ 环境监控      │   │
│         └─────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
```

### 15.8 开发测试生产环境数据流转详图

```
┌─────────────────────────────────────────────────────────────────┐
│                   三环境数据流转详细流程                         │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  开发环境                测试环境               生产环境         │
│  ┌──────┐              ┌──────┐              ┌──────┐         │
│  │代码库 │              │代码库 │              │代码库 │         │
│  └───┬──┘              └───▲──┘              └───▲──┘         │
│      │                     │                     │              │
│      │ 1.开发             │ 4.同步             │ 7.发布       │
│      ▼                     │                     │              │
│  ┌──────┐              ┌──────┐              ┌──────┐         │
│  │构建  │              │构建  │              │部署  │         │
│  └───┬──┘              └───▲──┘              └───▲──┘         │
│      │                     │                     │              │
│      │ 2.打包             │ 5.导入             │ 8.拉取       │
│      ▼                     │                     │              │
│  ┌──────┐   3.加密传输  ┌──────┐   6.测试通过  ┌──────┐         │
│  │制品  │ ═══════════> │制品  │ ───────────> │制品  │         │
│  │仓库  │   U盘/光盘   │仓库  │   版本系统   │仓库  │         │
│  └──────┘              └──────┘              └──────┘         │
│                                                                 │
│  ┌──────────────────────────────────────────────────┐         │
│  │               数据流转控制点                       │         │
│  │  • 开发→测试: 审批+加密+物理传输                  │         │
│  │  • 测试→生产: 版本管理+单向推送                  │         │
│  │  • 生产→外部: 完全禁止                          │         │
│  └──────────────────────────────────────────────────┘         │
└─────────────────────────────────────────────────────────────────┘
```