# 成功率阈值配置说明

## 概述

根据用户需求，成功率阈值不再基于历史交易数据动态计算，而是采用固定值或手工指定的方式。这样可以确保告警阈值的稳定性和可预测性。

## 配置方式

### 1. 配置文件方式（推荐）

在 `flink-data-transformer-module/src/main/resources/threshold-config.yaml` 文件中配置：

```yaml
# 动态阈值生成器配置
threshold:
  # 成功率阈值配置（固定值，不基于历史数据计算）
  success_rate:
    # 低级别告警阈值（低于此值触发LOW级别告警）
    low: 0.995    # 99.5%
    # 中级别告警阈值（低于此值触发MID级别告警）
    mid: 0.99     # 99.0%
    # 高级别告警阈值（低于此值触发HIGH级别告警）
    high: 0.985   # 98.5%
```

### 2. 默认值方式

如果未提供配置文件或配置文件读取失败，系统将使用以下默认值：

- **LOW级别告警阈值**: 99.5%
- **MID级别告警阈值**: 99.0%
- **HIGH级别告警阈值**: 98.5%

## 修改说明

### 修改的文件

1. **EventsBasedThresholdGenerator.java**
   - 移除了基于历史数据计算成功率阈值的逻辑
   - 添加了配置文件读取功能
   - 使用固定成功率阈值

2. **HourlyDynamicThresholdGenerator.java**
   - 同样移除了基于历史数据计算成功率阈值的逻辑
   - 添加了配置文件读取功能
   - 使用固定成功率阈值

3. **threshold-config.yaml** (新增)
   - 新增配置文件，支持手工指定成功率阈值

### 核心变更

#### 之前的逻辑（已移除）
```java
// 成功率阈值（基于历史数据计算）
double successRateLowThreshold = successRate - (errorRateStd * 0.5) * factor.successRateFactor;
double successRateMidThreshold = successRate - (errorRateStd * 1.0) * factor.successRateFactor;
double successRateHighThreshold = successRate - (errorRateStd * 2.0) * factor.successRateFactor;

rule.successRateLow = Math.max(successRateLowThreshold, successRate * 0.98);
rule.successRateMid = Math.max(successRateMidThreshold, successRate * 0.95);
rule.successRateHigh = Math.max(successRateHighThreshold, successRate * 0.90);
```

#### 现在的逻辑（固定值）
```java
// 成功率阈值（固定值，不基于历史数据计算）
rule.successRateLow = thresholdConfig.successRateLow;   // 99.5%
rule.successRateMid = thresholdConfig.successRateMid;   // 99.0%
rule.successRateHigh = thresholdConfig.successRateHigh; // 98.5%
```

## 使用方法

### 1. 使用默认阈值

直接运行程序，系统将使用默认的成功率阈值：
- LOW: 99.5%
- MID: 99.0%
- HIGH: 98.5%

### 2. 自定义阈值

1. 编辑 `threshold-config.yaml` 文件
2. 修改 `success_rate` 部分的 `low`、`mid`、`high` 值
3. 重新运行程序

### 3. 示例配置

```yaml
threshold:
  success_rate:
    low: 0.998    # 99.8% - 更严格的低级别告警
    mid: 0.995    # 99.5% - 更严格的中级别告警
    high: 0.99    # 99.0% - 更严格的高级别告警
```

## 优势

1. **稳定性**: 阈值不再受历史数据波动影响
2. **可预测性**: 告警行为更加可预测
3. **灵活性**: 支持手工调整阈值
4. **一致性**: 所有服务和操作使用相同的成功率标准

## 注意事项

1. 成功率阈值是"低于阈值告警"，即成功率低于设定值时触发告警
2. 建议根据业务要求设置合理的阈值，避免过于严格或过于宽松
3. 配置文件修改后需要重新运行程序才能生效
4. 如果配置文件格式错误，系统会自动回退到默认值 