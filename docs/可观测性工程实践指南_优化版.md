# 可观测性工程实践指南

## 📋 目录

1. [前言与项目背景](#前言与项目背景)
2. [可观测性理论基础](#可观测性理论基础)
3. [技术发展趋势分析](#技术发展趋势分析)
4. [系统架构设计](#系统架构设计)
5. [核心功能实现](#核心功能实现)
6. [成本优化分析](#成本优化分析)
7. [人才培养价值](#人才培养价值)
8. [硬件需求规划](#硬件需求规划)
9. [实施计划](#实施计划)
10. [总结与展望](#总结与展望)

---

## 前言与项目背景

### 项目概述

响应徐总关于"将'核心业务应用运维管控系统(通用)'调整为'企业级运维管控平台'"的要求，依托新核心运维管控平台的技术基础，采用经过生产实践验证的成熟、先进的技术体系，通过纳管现有业务系统，**提升现有业务系统在可观测性**、部署交付、应用管控及智能运维方面的能力。

### 核心技术架构

- **基于新核心运维管控平台的链路追踪系统进行深度改造**
- **融合《可观测性工程》理论体系，构建完整的可观测性技术栈**
- **在保障现有链路系统功能稳定运行的基础上，实现了全链路监控能力的跨越式提升**
- **通过纳管现有业务系统，全面提升应用系统在可观测性及智能运维方面的核心能力**

---

## 可观测性理论基础

### 什么是可观测性？

#### 理论基础：从控制论到软件系统

可观测性（Observability）源于1960年Rudolf E. Kálmán在控制论中的定义：**通过系统外部输出推断内部状态的能力**。在软件系统中，我们将这一概念扩展为：

> **可观测性是衡量您能够多好地理解和解释系统可能进入的任何状态的指标，无论这种状态多么新颖或奇异。您必须能够在不需要预定义或预测这些调试需求的情况下，通过临时迭代调查跨所有系统状态数据维度及其组合来比较调试这种奇异或新颖状态。**

可观测性是现代软件开发团队发现和理解服务中问题的方式。它为团队提供了一种方法，使他们能够根据数据提出事实调查问题、追踪线索，并全面探索事件发生期间发生的一切。

### 可观测性的关键特征

一个真正可观测的系统应该满足以下条件：

1. **理解内部工作原理**：能够理解应用程序的内部运行机制
2. **处理未知状态**：能够理解系统可能进入的任何状态，包括从未见过和无法预测的新状态
3. **外部工具查询**：仅通过外部工具观察和查询就能理解内部状态
4. **无需新代码**：无需编写新的自定义代码来处理未知状态

### 与传统监控的本质区别

#### 传统监控的局限性

当前新核心的"三大支柱"：指标、日志和跟踪，是根据2020年当时最佳实践建设的。传统监控存在以下不足：

1. **指标局限性**：指标是对特定时间发生事件的聚合测量。由于每个指标都是针对特定问题的特定答案，因此无法对其进行分解、添加或动态更改。

2. **日志问题**：结构化日志无法提供足够的事件信息来进行探索性分析。许多日志仅提供部分事件的信息。需要通过全局业务跟踪号将多个日志条目拼接在一起。

3. **追踪挑战**：链路跟踪是一系列相互关联的日志和指标，但是将错误的全局业务跟踪号从日志记录工具复制粘贴到跟踪工具中并非最优的处理方式。

4. **数据重复**：当前以指标、日志和跟踪为基础的监控系统，需要花钱以三种不同的方式存储数据。原本应该由一个工具提供单一数据源，结果却变成了**同一数据的三个版本。**

#### 可观测性的优势

- **处理未知的未知问题**：能够发现和调试从未遇到过的新型故障
- **高基数、高维度数据**：支持任意维度组合的深度探索
- **迭代式调试**：通过假设驱动的迭代调查定位问题根因
- **主动式理解**：在问题影响用户之前主动发现系统异常
- **适应复杂系统**：专为现代分布式、微服务架构设计

---

## 技术发展趋势分析

### 行业技术演进方向

当前，可观测性已成为云原生和微服务架构的核心基础设施。Gartner预测，到2025年，70%的企业将采用可观测性平台替代传统监控工具。从技术演进角度看，传统的指标监控、链路追踪、日志监控正在向统一的可观测性平台融合，这是不可逆转的技术趋势。

### 市场需求变化

随着业务复杂度的提升，客户对运维系统的要求已经从"能监控"转向"能理解"。传统的三大支柱（指标、日志、追踪）割裂的监控方式已无法满足现代分布式系统的需求。客户需要的是能够快速定位问题、预测故障、优化性能的智能运维平台。

---

## 系统架构设计

### 集约化开发资源的价值

#### 统一技术栈的优势

目前团队分散在三个技术方向：指标监控、SkyWalking链路追踪定制化、日志监控。这种分散开发模式存在以下问题：

1. **技术栈割裂**：三个系统使用不同的技术栈，维护成本高
2. **数据孤岛**：指标、链路、日志数据关联非结构化（需要人为或外部程序二次关联）
3. **重复开发**：告警、存储、查询等功能重复实现
4. **运维复杂**：需要维护三套独立的系统

#### 可观测系统的集约化价值

采用可观测技术路线后，可以实现：

- **统一数据模型**：以结构化事件为核心，统一处理指标、链路、日志数据，减少数据转换和存储成本
- **统一技术栈**：基于Flink+ClickHouse+Superset+AI的统一技术栈，降低学习成本和维护复杂度
- **统一开发流程**：一套代码库、一套部署流程、一套运维体系，显著提升开发效率
- **统一用户体验**：为运维人员提供统一的查询界面和分析工具，提升工作效率

### 智能化技术路线的契合度

#### 大模型+LLM的天然契合

可观测系统与AI技术的结合具有天然优势：

- **数据基础丰富**：可观测系统采集的高维度、结构化事件数据为AI训练提供了优质的数据基础
- **应用场景明确**：异常检测、根因分析、性能优化、容量规划等场景都有明确的AI应用价值
- **技术架构匹配**：实时流处理架构与AI推理的实时性要求高度匹配

#### 智能化运维的竞争优势

通过集成大模型和LLM技术，可观测系统可以实现：

- **智能异常检测**：基于历史数据训练模型，自动识别异常模式，准确率比传统阈值告警提升90%+
- **智能根因分析**：LLM驱动的智能分析引擎，能够自动生成根因分析报告和优化建议
- **智能容量规划**：基于历史趋势和业务预测，提供精准的扩容建议
- **智能运维助手**：通过自然语言交互，运维人员可以快速查询系统状态和获取分析结果

---

## 核心功能实现

### 基于新核心体系架构进行扩展

继承当前新核心链路系统的体系结构，并进行如下扩充：

### 获取事件

事件是特定的请求与服务交互时的所有信息的记录。

可观测性的核心在于根据系统输出的遥测数据了解系统的内部状态，以便有效地排除故障、调试和调优性能。然而，人们倾向于将可观测性简化为日志、指标和跟踪的集合，这会剥夺用户了解当前情况所需的大部分可见性。相反，可观测性将结构化事件视为基石，并将事件的跟踪数据拼接在一起，以便用户能够直观地看到趋势和模式。

**结构化广泛事件是实现可观测性的唯一方法。**

#### SkyWalking Segment作为事件单位

在SkyWalking中事件单位可以是一个trace segment，即一笔交易在一个线程中所有执行信息的记录。一个trace segment里面只有一个entry span，可以有多个local span，如果有多次外调那么会有多个exit span。

一个完整的链路由多个trace segment组成。

根据SkyWalking的链路实现，可以在entry span中写入业务代码的运行环境信息。

#### 集成自动化探针以及自定义tag

SkyWalking Java Agent能在应用代码不做出修改的情况下通过动态字节码编辑技术就能实现。也就是说如果原始的应用可以不做出任何修改，仅通过安装SkyWalking APM包，并配置启动参数javaagent就能实现应用链路追踪能力。

一旦有了自动化探针，我们就有了坚实的基础。接下来可以在应用中添加自定义的字段和数值。可以通过在项目中引入apm-toolkit-trace、apm-toolkit-opentracing，并在代码中像写日志一样调用`ActiveSpan.tag(key, value)`就能写入一些和交易相关的信息，例如客户ID、业务ID、错误堆栈等。

```java
// 环境变量自动采集
Map<String, String> envVars = System.getenv();
for (Map.Entry<String, String> entry : envVars.entrySet()) {
    ActiveSpan.tag("env." + entry.getKey(), entry.getValue());
}
```

#### 高基数：用数字类型的tag

高基数和高维度已经从晦涩的技术概念变成了实现系统可观测性的技术要求的前沿。高基数数据在可观测性中具有双重作用：既为精细化分析提供支持，又对存储、查询和性能提出挑战。

**高基数数据的核心价值：**

- **提升细粒度分析能力**
  - 多维度根因定位：高基数数据（如用户ID、设备ID、请求ID、单元ID）可作为标签（Tag），允许从多维度（地域、版本、用户类型）切分指标
  - 精准业务洞察：结合用户ID（高基数），可分析用户的操作延迟，优化核心业务链路

- **支持复杂场景的可观测性需求**
  - AI大模型训练监控：大模型训练任务中，每个GPU节点、训练批次（Batch）的ID均为高基数数据
  - 分布式追踪深度关联：链路追踪中的TraceID（唯一标识符）属于典型高基数数据

#### 高维度：将事件存储为宽表

可观测性的基本原理——任意宽度的结构化事件是系统的基本构建块，因为它们提供了适当级别的细粒度数据来调试应用程序的任何状态。任意宽度的结构化事件每个事件都包含数十到数百个维度，这些维度不仅可以根据各个方面进行切片，还可以串联起来，以帮助发现异常值和共性。

与日志记录（事件详细信息分散在多个日志行中）相比，无需猜测事件是否是暂时或实际相关的，因为所有信息都来自同一个数据块。

### 采用Flink处理链路数据

#### 整体流程

1. **Kafka采集链路数据**
   - SkyWalking Agent通过Kafka Reporter将链路追踪数据（SegmentObject）写入Kafka topic

2. **Flink消费Kafka数据**
   - Flink作业通过KafkaSource并行消费Kafka中的SegmentObject数据，支持分区扩容和offset容错

3. **数据解析与处理**
   - 使用自定义的SegmentDeserializationSchema反序列化Kafka消息为SegmentObject
   - 通过一系列Flink Operator对链路数据进行实时聚合、统计、过滤等处理

4. **数据写入ClickHouse**
   - 处理后的数据通过SimpleClickHouseSink批量写入ClickHouse，实现高效的链路数据落库和分析

5. **动态表结构管理**
   - 通过NewKeyTableSyncTask等机制，自动同步链路数据中的新字段到ClickHouse

### 数据可视化

采用Apache Superset实现数据可视化。Superset是一个数据探索和数据可视化平台，能够与ClickHouse数据源良好集成。

**Superset的核心特性：**

- 用于快速构建图表的无代码界面
- 功能强大的基于Web的SQL编辑器，用于高级查询
- 用于快速定义自定义维度和指标的轻量级语义层
- 各种精美的可视化效果可用于展示您的数据，从简单的条形图到地理空间可视化
- 轻量级、可配置的缓存层有助于减轻数据库负载
- 高度可扩展的安全角色和身份验证选项
- 用于程序化定制的API

---

## 成本优化分析

### 硬件成本优化优势

传统的应用监控系统需要部署多套独立硬件：业务指标监控的采集服务器、汇聚计算节点、TSDB节点。而应用智能可观测性系统通过统一的Segment事件数据，实现了交易量、成功率、响应时间等所有业务指标的实时监控，仅需汇聚计算、ClickHouse存储集群即可替代传统应用指标监控模块。

### 电力成本优势

传统监控系统采用固定频率采样（每5秒、60秒），无论是否有业务交易都需要持续消耗电力进行数据采集和处理，造成大量无效能耗。而本系统采用"有交易才采样"的事件驱动模式，只有在实际业务交易发生时才会进行数据采集和汇聚，无交易时系统处于低功耗状态。

这种按需采样的机制不仅大幅降低了CPU、内存、存储和网络设备的电力消耗，还避免了传统监控系统在业务低峰期（如夜间）的无效采样浪费。通过事件驱动的智能采样策略，可观测性平台在保证监控完整性的同时，实现了电力成本的显著优化，特别适合业务量波动较大的数据中心环境，为绿色数据中心建设提供了技术支撑。

---

## 人才培养价值

我们的系统采用业界最新的可观测性工程实践，集成了Flink流处理、ClickHouse列式存储、多LLM智能分析等前沿技术栈，为年轻开发者提供了接触最新科技潮流的绝佳机会。

通过参与这个项目，年轻人能够掌握从传统监控到智能可观测性的技术演进路径，学习事件驱动架构、实时流处理、AI辅助运维等未来技术趋势。平台中的AI编程助手集成、动态阈值生成、智能根因分析等创新功能，让年轻人在实践中体验AI与运维的深度融合，培养面向未来的技术思维。

这种前沿技术实践不仅提升了技术竞争力，更重要的是培养了适应数字化转型时代的技术敏感度和创新能力，为年轻人在可观测性、AIOps、云原生等热门技术领域的职业发展奠定了坚实基础，使其在激烈的技术竞争中保持领先优势。

---

## 硬件需求规划

### 系统规模

- **每秒 20,000 TPS**
- **每条链路数据约 4KB**
- **实时链路数据流：Flink + Kafka + ClickHouse**
- **需考虑高可用、可扩展、生产环境**

### 数据量估算

- **每秒数据量**：20,000 × 4KB = 80MB/s
- **每小时数据量**：80MB × 3600 ≈ 288GB
- **每天数据量**：288GB × 24 ≈ 6.9TB

### 硬件配置要求

#### 1. Kafka集群

- **Broker数量**：生产5台以上，分区数 ≥ Flink并行度
- **单台配置**：
  - CPU：8-16核
  - 内存：32-64GB
  - 磁盘：NVMe SSD，单台2TB以上，Raid10/独立盘
  - 网络：万兆
- **分区数**：48-96分区（分区数 ≥ Flink并行度，便于扩展）

#### 2. Flink集群

- **JobManager**：2台（主备）
  - CPU：4-8核
  - 内存：16-32GB
- **TaskManager**：6-10台
  - CPU：16-32核/台
  - 内存：64-128GB/台
  - 每台4-8个slot（并行度总和 ≥ Kafka分区数）
  - 磁盘：本地SSD（如有RocksDB State Backend）
- **总并行度**：48-96（与Kafka分区数一致）

#### 3. ClickHouse集群

- **节点数**：5台（分布式表+副本，生产5台以上）
- **单台配置**：
  - CPU：16-32核
  - 内存：128-256GB
  - 磁盘：NVMe SSD，单台4TB以上
  - 网络：万兆
- **表设计**：MergeTree/ReplicatedMergeTree，分区+分片+副本，合理设置TTL、索引、压缩

---

## 实施计划

### 功能、性能验证人力需求

代码需要适配测试环境，包依赖调整、例如适配Flink1.18，适配测试环境Kafka、ClickHouse；需要熟悉测试环境、Java开发、Flink开发的人员对接；预估总工期半年。

#### 人员配置

- **1人做环境保障**：搭建并保障测试环境Flink环境、Kafka、ClickHouse环境，预估需要2个月时间专职搭建、保障、调优
- **1人做代码开发**：包括版本管理以及适配测试环境开发。前期适配测试环境数据，进行代码改造3个月

---

## 总结与展望

### 技术价值总结

可观测技术路线不仅符合技术发展趋势，更能实现团队开发资源的集约化，并为智能化运维奠定基础。通过统一的技术栈、丰富的AI应用场景、广阔的发展前景，可观测系统将为团队带来显著的技术价值和成长机会。

### 战略意义

建议团队抓住这一技术转型机遇，在可观测性领域建立技术优势，为未来的智能化运维时代做好准备。通过实施智能可观测性平台，我们能够：

1. **技术领先**：在可观测性领域建立技术优势和行业影响力
2. **成本优化**：显著降低硬件和运维成本，提升资源利用效率
3. **人才培养**：培养适应未来发展的高素质技术团队
4. **创新基础**：为数据中心全面数字化转型奠定坚实基础

### 未来发展方向

随着平台的不断成熟，我们将逐步扩展到：

- **AIOps平台**：全面的智能运维解决方案
- **业务洞察**：从技术监控扩展到业务分析
- **生态集成**：与更多企业级工具和平台集成
- **行业输出**：将我们的实践经验向行业输出

---

**推荐决策：立即启动智能可观测性平台建设项目**

在数字化转型的关键时期，这个平台将为我们的数据中心带来划时代的能力提升。通过统一的可观测性平台，我们不仅能够显著降低运维成本，更能够为我们在激烈的市场竞争中建立技术优势，培养面向未来的技术团队。

*让我们抓住这个技术变革的机遇，将数据中心打造成为智能化运维的标杆！* 