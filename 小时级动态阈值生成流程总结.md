# åŸºäº flink_operator_agg_result çš„å°æ—¶çº§åŠ¨æ€é˜ˆå€¼ç”Ÿæˆæµç¨‹æ€»ç»“

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£è¯¦ç»†è®°å½•äº†å½“å‰å·¥ç¨‹ä¸­é€šè¿‡ç»Ÿè®¡ `flink_operator_agg_result` è¡¨ä¸­å†å²æ±‡æ€»äº¤æ˜“ä¿¡æ¯ï¼Œå¹¶æŒ‰å°æ—¶è¿›è¡Œä¿¡æ¯æ±‡æ€»ç”Ÿæˆå‘Šè­¦é˜ˆå€¼çš„å®Œæ•´æŠ€æœ¯æµç¨‹ã€‚è¯¥ç³»ç»Ÿå®ç°äº†ä»å†å²æ•°æ®åˆ†æåˆ°å®æ—¶å‘Šè­¦çš„æ™ºèƒ½åŒ–é—­ç¯ï¼Œå…·å¤‡å°æ—¶çº§ç²¾åº¦çš„å·®å¼‚åŒ–é˜ˆå€¼ç­–ç•¥ã€‚

## ğŸ—ï¸ æ•´ä½“æ¶æ„æµç¨‹å›¾

```mermaid
graph TD
    A[Segmentæ•°æ®æµ] --> B[AggregateOperatorèšåˆç®—å­]
    B --> C[ServiceAggResultèšåˆç»“æœ]
    C --> D[AggResultClickHouseSink]
    D --> E[flink_operator_agg_resultè¡¨]
    
    F[HourlyRuleSchedulerè°ƒåº¦å™¨] --> G[HourlyDynamicThresholdGeneratorç”Ÿæˆå™¨]
    G --> H[åˆ†æå‰7å¤©å†å²æ•°æ®]
    H --> I[æŒ‰å°æ—¶åˆ†ç»„ç»Ÿè®¡]
    I --> J[ç”Ÿæˆ24å°æ—¶é˜ˆå€¼è§„åˆ™]
    J --> K[hourly_alarm_rulesè¡¨]
    
    L[HourlyRulePublishProcessFunction] --> M[å®šæ—¶è¯»å–å½“å‰å°æ—¶è§„åˆ™]
    M --> N[æ¨é€åˆ°Kafka alarm_rule_topic]
    N --> O[RuleBroadcastStreamFactoryå¹¿æ’­æµ]
    O --> P[AggAlertBroadcastFunctionçƒ­æ›´æ–°]
    
    E --> G
    K --> L
    P --> Q[å®æ—¶å‘Šè­¦åˆ¤æ–­]
    C --> Q
    
    style A fill:#e1f5fe
    style E fill:#f3e5f5
    style K fill:#f3e5f5
    style Q fill:#ffebee
    style G fill:#e8f5e8
    style P fill:#fff3e0
```

## ğŸ—„ï¸ 1. æ•°æ®æ”¶é›†é˜¶æ®µ

### æ ¸å¿ƒè¡¨ç»“æ„ï¼šflink_operator_agg_result

```sql
CREATE TABLE flink_operator_agg_result (
    window_start  DateTime64(3),     -- çª—å£èµ·å§‹æ—¶é—´
    windowSize    Int32,             -- çª—å£å¤§å°ï¼ˆç§’ï¼‰
    operator_class String,           -- ç®—å­ç±»å…¨å  
    operator_name String,            -- ç®—å­ç±»å
    service       String,            -- æœåŠ¡å
    avg_duration  Float64,           -- å¹³å‡è€—æ—¶
    max_duration  Int64,             -- æœ€å¤§è€—æ—¶
    error_rate    Float64,           -- é”™è¯¯ç‡
    total_count   Int64,             -- æ€»è°ƒç”¨æ¬¡æ•°
    error_count   Int64,             -- é”™è¯¯è°ƒç”¨æ¬¡æ•°
    success_count Int64              -- æˆåŠŸè°ƒç”¨æ¬¡æ•°
    -- å…¶ä»–å­—æ®µ...
) ENGINE = MergeTree()
ORDER BY (window_start);
```

### æ•°æ®å†™å…¥æµç¨‹

1. **æ•°æ®æº**ï¼šFlinkæ¶ˆè´¹Kafkaä¸­çš„Segmentæ•°æ®æµ
2. **èšåˆå¤„ç†**ï¼š`AggregateOperator` å¯¹åŸå§‹æ•°æ®è¿›è¡Œçª—å£èšåˆï¼ˆé»˜è®¤22ç§’çª—å£ï¼‰
3. **ç»“æœå¯¹è±¡**ï¼šç”Ÿæˆ `ServiceAggResult` èšåˆç»“æœå¯¹è±¡
4. **æŒä¹…åŒ–**ï¼šé€šè¿‡ `AggResultClickHouseSink` å†™å…¥ClickHouseçš„ `flink_operator_agg_result` è¡¨

### å…³é”®ä»£ç ç»„ä»¶

- **èšåˆç®—å­**ï¼š`com.o11y.stream.operator.aggregate.AggregateOperator`
- **ç»“æœæ¨¡å‹**ï¼š`com.o11y.domain.model.aggregation.ServiceAggResult`
- **æ•°æ®å†™å…¥**ï¼š`com.o11y.stream.sink.AggResultClickHouseSink`

## ğŸ“ˆ 2. æ•°æ®åˆ†æä¸é˜ˆå€¼ç”Ÿæˆé˜¶æ®µ

### æ ¸å¿ƒç»„ä»¶

- **è°ƒåº¦å™¨**ï¼š`HourlyRuleScheduler` - è´Ÿè´£å¯åŠ¨è§„åˆ™ç”Ÿæˆä»»åŠ¡
- **ç”Ÿæˆå™¨**ï¼š`HourlyDynamicThresholdGenerator` - å®ç°æ™ºèƒ½é˜ˆå€¼ç®—æ³•

### åˆ†æSQLæŸ¥è¯¢

```sql
SELECT 
    toHour(window_start) as hour_of_day,  -- æŒ‰å°æ—¶åˆ†ç»„ (0-23)
    service, 
    operator_name,
    operator_class,
    -- åŸºç¡€ç»Ÿè®¡æŒ‡æ ‡
    avg(avg_duration) as avg_avg_duration,
    avg(max_duration) as avg_max_duration, 
    avg(error_rate) as avg_error_rate,
    avg(total_count) as avg_total_count,
    count(*) as sample_count,
    -- æ ‡å‡†å·®ï¼ˆç”¨äºåŠ¨æ€é˜ˆå€¼è®¡ç®—ï¼‰
    stddevSamp(avg_duration) as avg_duration_std,
    stddevSamp(max_duration) as max_duration_std,
    -- åˆ†ä½æ•°ï¼ˆç”¨äºæ›´ç²¾å‡†çš„é˜ˆå€¼è®¾å®šï¼‰
    quantile(0.75)(avg_duration) as avg_duration_p75,
    quantile(0.90)(avg_duration) as avg_duration_p90,
    quantile(0.95)(avg_duration) as avg_duration_p95
FROM flink_operator_agg_result 
WHERE window_start >= now() - INTERVAL ? DAY  -- é»˜è®¤åˆ†æå‰7å¤©
GROUP BY hour_of_day, service, operator_name, operator_class
HAVING sample_count >= ?  -- ä¿è¯æ ·æœ¬å……è¶³æ€§
ORDER BY hour_of_day, service, operator_name
```

### æ™ºèƒ½é˜ˆå€¼ç®—æ³•

#### ä¸‰çº§é˜ˆå€¼è®¡ç®—ç­–ç•¥

```java
// å°æ—¶çº§ç‰¹å¾è°ƒæ•´å› å­
HourlyAdjustmentFactor factor = getHourlyAdjustmentFactor(hourOfDay);

// åŸºäºåˆ†ä½æ•° + æ ‡å‡†å·®çš„åŠ¨æ€é˜ˆå€¼
rule.avgDurationLow = max(P75 + 0.5*std*factor, avgDuration*1.1);
rule.avgDurationMid = max(P90 + 1.0*std*factor, avgDuration*1.3);  
rule.avgDurationHigh = max(P95 + 2.0*std*factor, avgDuration*1.8);
```

#### å°æ—¶ç‰¹å¾è¯†åˆ«

| æ—¶æ®µç±»å‹ | å°æ—¶èŒƒå›´ | é˜ˆå€¼ç­–ç•¥ | è°ƒæ•´å› å­ |
|---------|---------|---------|---------|
| **é«˜å³°æœŸ** | 9-11, 14-16, 20-22ç‚¹ | é˜ˆå€¼ç›¸å¯¹å®½æ¾ | factor > 1.0 |
| **ä½å³°æœŸ** | 0-6ç‚¹ | é˜ˆå€¼ç›¸å¯¹ä¸¥æ ¼ | factor < 1.0 |
| **å¹³å³°æœŸ** | å…¶ä»–æ—¶æ®µ | æ ‡å‡†é˜ˆå€¼ | factor = 1.0 |

#### å¤šç»´åº¦é˜ˆå€¼è¦†ç›–

1. **å¹³å‡å»¶è¿Ÿé˜ˆå€¼**ï¼šåŸºäºP75/P90/P95åˆ†ä½æ•°
2. **æœ€å¤§å»¶è¿Ÿé˜ˆå€¼**ï¼šè¯†åˆ«æ…¢è¯·æ±‚å¼‚å¸¸
3. **æˆåŠŸç‡é˜ˆå€¼**ï¼šç›‘æ§æœåŠ¡å¯ç”¨æ€§ï¼ˆä½äºé˜ˆå€¼å‘Šè­¦ï¼‰
4. **äº¤æ˜“é‡é˜ˆå€¼**ï¼šæ£€æµ‹æµé‡æ¿€å¢ï¼ˆé«˜äºé˜ˆå€¼å‘Šè­¦ï¼‰

## ğŸ—ƒï¸ 3. è§„åˆ™å­˜å‚¨é˜¶æ®µ

### è§„åˆ™è¡¨ç»“æ„ï¼šhourly_alarm_rules

```sql
CREATE TABLE hourly_alarm_rules (
    hour_of_day UInt8,               -- å°æ—¶åºå· (0-23)
    service String,                  -- æœåŠ¡å
    operator_name String,            -- æ“ä½œå‘˜å
    operator_class String,           -- æ“ä½œå‘˜ç±»
    
    -- å¤šçº§é˜ˆå€¼ï¼ˆé«˜ä¸­ä½ä¸‰æ¡£ï¼‰
    avg_duration_low Float64,        -- å¹³å‡å»¶è¿Ÿä½é˜ˆå€¼
    avg_duration_mid Float64,        -- å¹³å‡å»¶è¿Ÿä¸­é˜ˆå€¼
    avg_duration_high Float64,       -- å¹³å‡å»¶è¿Ÿé«˜é˜ˆå€¼
    max_duration_low Float64,        -- æœ€å¤§å»¶è¿Ÿä½é˜ˆå€¼
    max_duration_mid Float64,        -- æœ€å¤§å»¶è¿Ÿä¸­é˜ˆå€¼
    max_duration_high Float64,       -- æœ€å¤§å»¶è¿Ÿé«˜é˜ˆå€¼
    success_rate_low Float64,        -- æˆåŠŸç‡ä½é˜ˆå€¼
    success_rate_mid Float64,        -- æˆåŠŸç‡ä¸­é˜ˆå€¼
    success_rate_high Float64,       -- æˆåŠŸç‡é«˜é˜ˆå€¼
    traffic_volume_low Float64,      -- äº¤æ˜“é‡ä½é˜ˆå€¼
    traffic_volume_mid Float64,      -- äº¤æ˜“é‡ä¸­é˜ˆå€¼
    traffic_volume_high Float64,     -- äº¤æ˜“é‡é«˜é˜ˆå€¼
    
    alarm_template String,           -- å‘Šè­¦æ¨¡æ¿
    analysis_days UInt8,             -- åˆ†æçš„å†å²å¤©æ•°
    sample_count UInt32,             -- æ ·æœ¬æ•°é‡
    generated_time DateTime,         -- è§„åˆ™ç”Ÿæˆæ—¶é—´
    last_updated DateTime,           -- æœ€åæ›´æ–°æ—¶é—´
    version UInt32,                  -- è§„åˆ™ç‰ˆæœ¬å·
    
    PRIMARY KEY (hour_of_day, service, operator_name)
) ENGINE = MergeTree()
ORDER BY (hour_of_day, service, operator_name);
```

### å­˜å‚¨ç‰¹ç‚¹

- **å®Œæ•´è¦†ç›–**ï¼šæ¯ä¸ªæœåŠ¡+ç®—å­ç»„åˆç”Ÿæˆ24æ¡è®°å½•ï¼ˆæ¯å°æ—¶ä¸€æ¡ï¼‰
- **æ•°æ®ä¸€è‡´æ€§**ï¼šæ”¯æŒæ‰¹é‡æ¸…ç†å’Œé‡æ–°ç”Ÿæˆ
- **å…ƒæ•°æ®ä¸°å¯Œ**ï¼šåŒ…å«æ ·æœ¬æ•°é‡ã€ç”Ÿæˆæ—¶é—´ç­‰ä¾¿äºè¿ç»´è°ƒè¯•
- **ç‰ˆæœ¬ç®¡ç†**ï¼šæ”¯æŒè§„åˆ™ç‰ˆæœ¬æ§åˆ¶å’Œå›æ»š

## â° 4. å®šæ—¶ä¸‹å‘é˜¶æ®µ

### æ ¸å¿ƒç»„ä»¶ï¼šHourlyRulePublishProcessFunction

åŸºäºFlinkçš„ProcessFunction + Timeræœºåˆ¶å®ç°ç²¾ç¡®çš„æ•´ç‚¹è§¦å‘ã€‚

#### å·¥ä½œæµç¨‹

```java
// æ¯å°æ—¶æ•´ç‚¹è§¦å‘çš„æ ¸å¿ƒé€»è¾‘
public void onTimer(long timestamp, OnTimerContext ctx, Collector<String> out) {
    int currentHour = LocalDateTime.now().getHour();
    
    // 1. æŸ¥è¯¢å½“å‰å°æ—¶çš„æ‰€æœ‰è§„åˆ™
    Map<String, AlarmRule> ruleMap = loadHourlyRules(currentHour);
    
    // 2. æ¨é€åˆ°Kafkaå®ç°çƒ­æ›´æ–°
    publishRulesToKafka(ruleMap, currentHour);
    
    // 3. æ³¨å†Œä¸‹ä¸€ä¸ªå°æ—¶çš„å®šæ—¶å™¨
    long nextCheckTime = calculateNextCheckTime();
    ctx.timerService().registerProcessingTimeTimer(nextCheckTime);
}
```

#### æŸ¥è¯¢å½“å‰å°æ—¶è§„åˆ™

```sql
SELECT service, operator_name, operator_class,
       avg_duration_low, avg_duration_mid, avg_duration_high,
       max_duration_low, max_duration_mid, max_duration_high,
       success_rate_low, success_rate_mid, success_rate_high,
       traffic_volume_low, traffic_volume_mid, traffic_volume_high,
       alarm_template
FROM hourly_alarm_rules 
WHERE hour_of_day = ?
```

#### å®šæ—¶æœºåˆ¶ç‰¹ç‚¹

- **ç²¾ç¡®è§¦å‘**ï¼šåŸºäºFlink Timerçš„æ¯«ç§’çº§ç²¾åº¦
- **æ•…éšœæ¢å¤**ï¼šæ”¯æŒFlink checkpointå’ŒçŠ¶æ€æ¢å¤
- **é¿å…é‡å¤**ï¼šä½¿ç”¨ValueStateè®°å½•ä¸Šæ¬¡æ‰§è¡Œæ—¶é—´
- **è‡ªåŠ¨å¾ªç¯**ï¼šæ¯æ¬¡æ‰§è¡Œåè‡ªåŠ¨æ³¨å†Œä¸‹æ¬¡å®šæ—¶å™¨

## ğŸ”„ 5. çƒ­æ›´æ–°ä¸å®æ—¶å‘Šè­¦é˜¶æ®µ

### å¹¿æ’­æµæ¶æ„

#### Kafka Topicé…ç½®

**Topic**: `alarm_rule_topic`

**å…³é”®é…ç½®**ï¼š
```properties
# å¯ç”¨Log Compactionç­–ç•¥
cleanup.policy=compact
min.cleanable.dirty.ratio=0.1
segment.ms=60000
delete.retention.ms=86400000
partitions=1
```

#### æ¶ˆè´¹ç­–ç•¥

- **èµ·å§‹ä½ç½®**ï¼š`earliest()` ç¡®ä¿å¯åŠ¨æ—¶è·å–æœ€æ–°è§„åˆ™
- **æ¶ˆè´¹ç»„**ï¼š`alarm-rule-consumer-group` å›ºå®šæ¶ˆè´¹ç»„ç®¡ç†offset
- **å¹¶è¡Œåº¦**ï¼šå•å¹¶è¡Œåº¦ç¡®ä¿è§„åˆ™æ¶ˆè´¹é¡ºåºæ€§

### å¹¿æ’­æµå¤„ç†

#### RuleBroadcastStreamFactory

```java
// æ„å»ºè§„åˆ™å¹¿æ’­æµçš„æ ¸å¿ƒæ–¹æ³•
public static BroadcastStream<Map<String, AlarmRule>> buildRuleBroadcastStream(
        StreamExecutionEnvironment env,
        Map<String, String> kafkaConfig,
        MapStateDescriptor<String, Map<String, AlarmRule>> ruleStateDescriptor) {
    
    // ä»Kafkaæ„å»ºæ•°æ®æº
    KafkaSource<Map<String, AlarmRule>> ruleSource = KafkaSource
        .<Map<String, AlarmRule>>builder()
        .setBootstrapServers(kafkaConfig.get("bootstrap_servers"))
        .setTopics(kafkaConfig.get("alarm_rule_topic"))
        .setGroupId(kafkaConfig.get("alarm_rule_group_id"))
        .setStartingOffsets(OffsetsInitializer.earliest())
        .setDeserializer(new AlarmRuleDeserializationSchema())
        .build();
    
    // åˆ›å»ºå¹¿æ’­æµ
    return env.fromSource(ruleSource, WatermarkStrategy.noWatermarks(), "alarm-rule-source")
              .setParallelism(1)
              .filter(Objects::nonNull)
              .broadcast(ruleStateDescriptor);
}
```

#### AggAlertBroadcastFunctionçƒ­æ›´æ–°

```java
// å®æ—¶å‘Šè­¦åˆ¤æ–­çš„æ ¸å¿ƒé€»è¾‘
public void processElement(ServiceAggResult value, ReadOnlyContext ctx, Collector<AlertMessage> out) {
    String key = value.getKey(); // service|operatorName
    Map<String, AlarmRule> ruleMap = ctx.getBroadcastState(ruleStateDescriptor).get("all_rules");
    
    if (ruleMap != null) {
        AlarmRule rule = ruleMap.get(key);
        if (rule != null) {
            AlertMessage alert = buildAlertReport(rule, value);
            out.collect(alert);
        }
    }
}

// è§„åˆ™çƒ­æ›´æ–°å¤„ç†
public void processBroadcastElement(Map<String, AlarmRule> ruleMap, Context ctx, Collector<AlertMessage> out) {
    // ä½¿ç”¨å›ºå®škeyå­˜å‚¨è§„åˆ™æ˜ å°„ï¼Œå®ç°çƒ­æ›´æ–°
    ctx.getBroadcastState(ruleStateDescriptor).put("all_rules", ruleMap);
    
    if (ruleMap != null && !ruleMap.isEmpty()) {
        LOG.info("[çƒ­æ›´æ–°] æ”¶åˆ°æ–°è§„åˆ™æ¶ˆæ¯ï¼Œè§„åˆ™æ€»æ•°ï¼š{}ï¼Œkeysï¼š{}", 
                ruleMap.size(), ruleMap.keySet());
    }
}
```

### å‘Šè­¦çº§åˆ«åˆ¤æ–­

#### å¤šæŒ‡æ ‡å¤šçº§é˜ˆå€¼åˆ†æ

```java
// å¹³å‡å»¶è¿Ÿå‘Šè­¦åˆ¤æ–­
if (rule.avgDurationHigh != null && value.avgDuration != null && 
    value.avgDuration > rule.avgDurationHigh) {
    conclusion.append("[HIGH] å¹³å‡å»¶è¿Ÿè¶…è¿‡é«˜é˜ˆå€¼ï¼Œå»ºè®®ç«‹å³æ’æŸ¥æœåŠ¡æ€§èƒ½ç“¶é¢ˆã€‚\n");
    alertLevel = "HIGH";
    triggered = true;
} else if (rule.avgDurationMid != null && value.avgDuration != null && 
           value.avgDuration > rule.avgDurationMid) {
    conclusion.append("[MID] å¹³å‡å»¶è¿Ÿè¶…è¿‡ä¸­é˜ˆå€¼ï¼Œå»ºè®®å…³æ³¨æœåŠ¡è¿‘æœŸå˜æ›´ã€‚\n");
    alertLevel = "MID";
    triggered = true;
} else if (rule.avgDurationLow != null && value.avgDuration != null && 
           value.avgDuration > rule.avgDurationLow) {
    conclusion.append("[LOW] å¹³å‡å»¶è¿Ÿè¶…è¿‡ä½é˜ˆå€¼ï¼Œå»ºè®®æŒç»­è§‚å¯Ÿã€‚\n");
    alertLevel = "LOW";
    triggered = true;
}

// æˆåŠŸç‡å‘Šè­¦åˆ¤æ–­ï¼ˆä½äºé˜ˆå€¼å‘Šè­¦ï¼‰
if (rule.successRateHigh != null && value.errorRate != null && 
    (1 - value.errorRate) < rule.successRateHigh) {
    conclusion.append("[HIGH] æˆåŠŸç‡ä½äºé«˜é˜ˆå€¼ï¼Œå»ºè®®ç«‹å³æ’æŸ¥å¼‚å¸¸åŸå› ã€‚\n");
    alertLevel = "HIGH";
    triggered = true;
}

// äº¤æ˜“é‡å‘Šè­¦åˆ¤æ–­ï¼ˆé«˜äºé˜ˆå€¼å‘Šè­¦ï¼‰
if (rule.trafficVolumeHigh != null && value.totalCount != null && 
    value.totalCount > rule.trafficVolumeHigh) {
    conclusion.append("[HIGH] äº¤æ˜“é‡é«˜äºé«˜é˜ˆå€¼ï¼Œå»ºè®®å…³æ³¨æµé‡æ¿€å¢åŸå› ã€‚\n");
    alertLevel = "HIGH";
    triggered = true;
}
```

## ğŸ¯ å…³é”®ç‰¹æ€§æ€»ç»“

### 1. æ™ºèƒ½åŒ–é˜ˆå€¼

- **å¤šç»´ç®—æ³•**ï¼šç»“åˆåˆ†ä½æ•°ã€æ ‡å‡†å·®å’Œå°æ—¶ç‰¹å¾çš„åŠ¨æ€é˜ˆå€¼
- **ç»Ÿè®¡å­¦åŸºç¡€**ï¼šä½¿ç”¨P75/P90/P95åˆ†ä½æ•°ç¡®ä¿é˜ˆå€¼çš„ç»Ÿè®¡æ„ä¹‰
- **è‡ªé€‚åº”è°ƒæ•´**ï¼šæ ¹æ®å†å²æ³¢åŠ¨è‡ªåŠ¨è°ƒæ•´é˜ˆå€¼æ•æ„Ÿåº¦

### 2. å°æ—¶çº§ç²¾åº¦

- **ä¸šåŠ¡æ„ŸçŸ¥**ï¼šè¯†åˆ«é«˜å³°æœŸã€ä½å³°æœŸã€å¹³å³°æœŸçš„ä¸åŒç‰¹å¾
- **å·®å¼‚åŒ–ç­–ç•¥**ï¼šé’ˆå¯¹ä¸åŒæ—¶æ®µé‡‡ç”¨å·®å¼‚åŒ–é˜ˆå€¼å€æ•°
- **ç²¾ç¡®è§¦å‘**ï¼šæ•´ç‚¹ä¸‹å‘å¯¹åº”æ—¶æ®µçš„ä¸“é—¨è§„åˆ™

### 3. é›¶åœæœºæ›´æ–°

- **Broadcast State**ï¼šåŸºäºFlinkå¹¿æ’­çŠ¶æ€çš„åˆ†å¸ƒå¼çƒ­æ›´æ–°
- **çŠ¶æ€ä¸€è‡´æ€§**ï¼šç¡®ä¿æ‰€æœ‰å¹¶è¡Œå®ä¾‹åŒæ­¥æ›´æ–°è§„åˆ™
- **æ— ä¸­æ–­æœåŠ¡**ï¼šè§„åˆ™æ›´æ–°è¿‡ç¨‹ä¸­å‘Šè­¦æœåŠ¡æŒç»­è¿è¡Œ

### 4. æ•°æ®å¯é æ€§

- **Log Compaction**ï¼šKafkaå‹ç¼©ç­–ç•¥ä¿è¯è§„åˆ™æ•°æ®æŒä¹…åŒ–
- **Earliestç­–ç•¥**ï¼šç¡®ä¿æ¶ˆè´¹è€…å¯åŠ¨æ—¶è·å–æœ€æ–°æœ‰æ•ˆè§„åˆ™
- **æ•…éšœæ¢å¤**ï¼šæ”¯æŒFlink checkpointå’Œè‡ªåŠ¨æ¢å¤

### 5. è¿ç»´å‹å¥½

- **å®Œæ•´æ—¥å¿—**ï¼šæ¯ä¸ªç¯èŠ‚éƒ½æœ‰è¯¦ç»†çš„ç›‘æ§æ—¥å¿—
- **çŠ¶æ€ç®¡ç†**ï¼šæ”¯æŒè§„åˆ™ç‰ˆæœ¬æ§åˆ¶å’ŒçŠ¶æ€æŸ¥è¯¢
- **å¼‚å¸¸å¤„ç†**ï¼šå®Œå–„çš„å¼‚å¸¸å¤„ç†å’Œé™çº§æœºåˆ¶

## ğŸ“Š æ€§èƒ½ä¸æ‰©å±•æ€§

### æ•°æ®é‡ä¼°ç®—

- **å†å²æ•°æ®**ï¼šåˆ†æå‰7å¤©æ•°æ®ï¼Œæ”¯æŒåƒä¸‡çº§è®°å½•æŸ¥è¯¢
- **è§„åˆ™æ•°é‡**ï¼šæ¯ä¸ªæœåŠ¡-ç®—å­ç»„åˆ24å°æ—¶è§„åˆ™ï¼Œæ”¯æŒä¸‡çº§è§„åˆ™ç®¡ç†
- **å®æ—¶å¤„ç†**ï¼šæ¯«ç§’çº§è§„åˆ™åŒ¹é…ï¼Œæ”¯æŒä¸‡çº§TPSå®æ—¶å‘Šè­¦

### æ‰©å±•èƒ½åŠ›

- **æ–°æŒ‡æ ‡æ‰©å±•**ï¼šè¡¨ç»“æ„å’Œç®—æ³•æ”¯æŒæ–°ç›‘æ§æŒ‡æ ‡
- **æ–°ç®—å­æ¥å…¥**ï¼šç»Ÿä¸€çš„ç®—å­æ³¨å†Œæœºåˆ¶
- **å¤šé›†ç¾¤éƒ¨ç½²**ï¼šæ”¯æŒå¤šæ•°æ®ä¸­å¿ƒå’Œå¤šç¯å¢ƒéƒ¨ç½²

## ğŸ”§ è¿ç»´å»ºè®®

### ç›‘æ§æŒ‡æ ‡

1. **è§„åˆ™ç”Ÿæˆç›‘æ§**ï¼šç›‘æ§æ¯æ—¥è§„åˆ™ç”ŸæˆæˆåŠŸç‡å’Œè€—æ—¶
2. **ä¸‹å‘å»¶è¿Ÿç›‘æ§**ï¼šç›‘æ§è§„åˆ™ä»ç”Ÿæˆåˆ°ç”Ÿæ•ˆçš„å»¶è¿Ÿ
3. **å‘Šè­¦å‡†ç¡®æ€§**ï¼šç›‘æ§å‘Šè­¦çš„å‡†ç¡®ç‡å’Œè¯¯æŠ¥ç‡
4. **ç³»ç»Ÿèµ„æº**ï¼šç›‘æ§ClickHouseæŸ¥è¯¢æ€§èƒ½å’ŒKafkaå»¶è¿Ÿ

### è°ƒä¼˜å»ºè®®

1. **æ ·æœ¬æ•°é‡è°ƒæ•´**ï¼šæ ¹æ®ä¸šåŠ¡é‡è°ƒæ•´æœ€å°æ ·æœ¬è¦æ±‚
2. **åˆ†æå‘¨æœŸè°ƒæ•´**ï¼šæ ¹æ®ä¸šåŠ¡ç¨³å®šæ€§è°ƒæ•´å†å²åˆ†æå¤©æ•°
3. **é˜ˆå€¼æ•æ„Ÿåº¦**ï¼šæ ¹æ®å‘Šè­¦æ•ˆæœè°ƒæ•´é˜ˆå€¼è®¡ç®—å‚æ•°
4. **å‹ç¼©ç­–ç•¥ä¼˜åŒ–**ï¼šæ ¹æ®è§„åˆ™æ›´æ–°é¢‘ç‡ä¼˜åŒ–Kafkaå‹ç¼©å‚æ•°

---

## ğŸ“ å˜æ›´è®°å½•

| ç‰ˆæœ¬ | æ—¥æœŸ | å˜æ›´å†…å®¹ | ä½œè€… |
|------|------|----------|------|
| 1.0 | 2024-12-19 | åˆå§‹ç‰ˆæœ¬ï¼Œå®Œæ•´æµç¨‹æ€»ç»“ | AI Assistant |

---

**æ–‡æ¡£çŠ¶æ€**ï¼šâœ… å½“å‰ç‰ˆæœ¬  
**æœ€åæ›´æ–°**ï¼š2024-12-19  
**é€‚ç”¨ç‰ˆæœ¬**ï¼šå½“å‰å·¥ç¨‹ä¸»åˆ†æ”¯ 