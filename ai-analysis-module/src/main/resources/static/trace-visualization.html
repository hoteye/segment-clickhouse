<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é“¾è·¯å¯è§†åŒ–æ¼”ç¤º</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 30px;
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
        }
        .section h2 {
            color: #555;
            border-bottom: 2px solid #007acc;
            padding-bottom: 10px;
        }
        .trace-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .trace-item {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .trace-item:hover {
            background: #e9ecef;
            border-color: #007acc;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .trace-id {
            font-family: 'Courier New', monospace;
            font-size: 12px;
            color: #666;
            margin-bottom: 8px;
        }
        .trace-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }
        .trace-services {
            font-size: 12px;
            color: #888;
            margin-top: 8px;
        }
        .buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 15px;
        }
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }
        .btn-primary {
            background: #007acc;
            color: white;
        }
        .btn-primary:hover {
            background: #005999;
        }
        .btn-success {
            background: #28a745;
            color: white;
        }
        .btn-success:hover {
            background: #1e7e34;
        }
        .btn-warning {
            background: #ffc107;
            color: #212529;
        }
        .btn-warning:hover {
            background: #e0a800;
        }
        .btn-info {
            background: #17a2b8;
            color: white;
        }
        .btn-info:hover {
            background: #117a8b;
        }
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .success {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .visualization-frame {
            width: 100%;
            height: 600px;
            border: 1px solid #ccc;
            border-radius: 4px;
            background: white;
            margin-top: 15px;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }
        .stat-number {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .stat-label {
            font-size: 0.9em;
            opacity: 0.9;
        }
        .api-demo {
            background: #f8f9fa;
            border-left: 4px solid #007acc;
            padding: 15px;
            margin: 15px 0;
        }
        .api-demo h3 {
            margin-top: 0;
            color: #007acc;
        }
        .api-demo code {
            background: #e9ecef;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
        }

        /* æ¨¡æ€æ¡†æ ·å¼ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            overflow-y: auto;
        }

        .modal-content {
            width: 90%;
            max-width: 1200px;
            height: 90vh;
            margin: 5vh auto;
            background: white;
            border-radius: 8px;
            position: relative;
            padding: 20px;
            display: flex;
            flex-direction: column;
        }

        .modal-close {
            position: absolute;
            right: 20px;
            top: 20px;
            font-size: 24px;
            cursor: pointer;
            color: #555;
        }

        .modal-close:hover {
            color: #000;
        }

        .modal-iframe {
            width: 100%;
            height: calc(90vh - 120px);
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-top: 15px;
        }

        /* Trace IDè¾“å…¥æ¡†æ ·å¼ */
        .trace-input-section {
            margin-bottom: 20px;
        }
        
        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            align-items: center;
        }
        
        .trace-input {
            flex: 1;
            padding: 10px 15px;
            border: 2px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            font-family: 'Courier New', monospace;
            transition: border-color 0.3s ease;
        }
        
        .trace-input:focus {
            outline: none;
            border-color: #007acc;
            box-shadow: 0 0 0 2px rgba(0, 122, 204, 0.2);
        }
        
        .trace-input::placeholder {
            color: #999;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” SkyWalking é“¾è·¯å¯è§†åŒ–æ¼”ç¤º</h1>
        
        <div class="section">
            <h2>ğŸ“Š ç³»ç»Ÿæ¦‚è§ˆï¼ˆè¿‘1å°æ—¶ï¼‰</h2>
            <div class="stats" id="stats">
                <div class="stat-card">
                    <div class="stat-number" id="trace-count">--</div>
                    <div class="stat-label">æœ€è¿‘é“¾è·¯æ•°</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="service-count">--</div>
                    <div class="stat-label">æ´»è·ƒæœåŠ¡æ•°</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="error-count">--</div>
                    <div class="stat-label">é”™è¯¯é“¾è·¯æ•°</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="avg-duration">--</div>
                    <div class="stat-label">å¹³å‡è€—æ—¶(ms)</div>
                </div>
            </div>
        </div>

        <div class="section">
            <h2>ğŸ”é“¾è·¯åˆ—è¡¨ï¼ˆæœ€è¿‘18ç¬”äº¤æ˜“ï¼‰</h2>
            <div class="trace-input-section">
                <div class="input-group">
                    <input type="text" id="trace-id-input" placeholder="è¯·è¾“å…¥Trace ID" class="trace-input">
                    <button class="btn btn-success" onclick="queryTraceById()">æŸ¥è¯¢</button>
                </div>
                <div class="buttons">
                    <button class="btn btn-primary" onclick="loadRecentTraces()">åˆ·æ–°é“¾è·¯</button>
                    <button class="btn btn-info" onclick="loadVisualizationTypes()">æŸ¥çœ‹å¯è§†åŒ–ç±»å‹</button>
                </div>
            </div>
            <div id="trace-list" class="trace-list">
                <div class="loading">æ­£åœ¨åŠ è½½é“¾è·¯æ•°æ®...</div>
            </div>
        </div>

        <div class="section">
            <h2>ğŸ¨ é“¾è·¯å¯è§†åŒ–å±•ç¤º</h2>
            <div id="visualization-content">
                <p>è¯·é€‰æ‹©ä¸€ä¸ªé“¾è·¯æŸ¥çœ‹å¯è§†åŒ–æ•ˆæœ</p>
                <div class="api-demo">
                    <h3>æ”¯æŒçš„å¯è§†åŒ–ç±»å‹ï¼š</h3>
                    <ul>
                        <li><strong>æœ‰å‘æ— ç¯å›¾ (DAG)</strong> - å±•ç¤ºæœåŠ¡é—´è°ƒç”¨å…³ç³»å’Œä¾èµ–</li>
                        <li><strong>ç€‘å¸ƒå›¾ (Waterfall)</strong> - æŒ‰æ—¶é—´è½´å±•ç¤ºå„spanæ‰§è¡Œæ—¶åº</li>
                        <li><strong>ç«ç„°å›¾ (FlameGraph)</strong> - æŒ‰è€—æ—¶å±•ç¤ºæ€§èƒ½çƒ­ç‚¹</li>
                        <li><strong>è°ƒç”¨æ ‘ (CallTree)</strong> - å±•ç¤ºå®Œæ•´è°ƒç”¨æ ˆå±‚æ¬¡ç»“æ„</li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="section">
            <h2>ğŸ”§ API æ¥å£æ¼”ç¤º</h2>
            <div class="api-demo">
                <h3>é“¾è·¯å¯è§†åŒ–æ¥å£</h3>
                <p><code>GET /api/trace-visualization/trace/{traceId}/dag</code> - ç”ŸæˆæœåŠ¡ä¾èµ–DAGå›¾</p>
                <p><code>GET /api/trace-visualization/trace/{traceId}/waterfall</code> - ç”Ÿæˆæ—¶åºç€‘å¸ƒå›¾</p>
                <p><code>GET /api/trace-visualization/trace/{traceId}/flame</code> - ç”Ÿæˆæ€§èƒ½ç«ç„°å›¾</p>
                <p><code>GET /api/trace-visualization/trace/{traceId}/tree</code> - ç”Ÿæˆè°ƒç”¨æ ‘</p>
                <p><code>GET /api/trace-visualization/trace/{traceId}/service-relations</code> - åˆ†ææœåŠ¡è°ƒç”¨å…³ç³»</p>
                <p><code>GET /api/trace-visualization/traces/recent</code> - è·å–æœ€è¿‘é“¾è·¯</p>
                <p><code>GET /api/trace-visualization/trace/{traceId}/details</code> - è·å–é“¾è·¯è¯¦æƒ…</p>
                <p><code>GET /api/trace-visualization/stats/recent-day</code> - è·å–æœ€è¿‘ä¸€å¤©ç»Ÿè®¡</p>
            </div>
        </div>
    </div>

    <!-- è°ƒç”¨æ ‘æ¨¡æ€æ¡† -->
    <div id="treeModal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeTreeModal()">&times;</span>
            <h2>è°ƒç”¨æ ‘å¯è§†åŒ–</h2>
            <div id="treeModalContent"></div>
        </div>
    </div>

    <!-- DAGå›¾æ¨¡æ€æ¡† -->
    <div id="dagModal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeDagModal()">&times;</span>
            <h2>DAGå›¾å¯è§†åŒ–</h2>
            <div id="dagModalContent"></div>
        </div>
    </div>

    <!-- ç€‘å¸ƒå›¾æ¨¡æ€æ¡† -->
    <div id="waterfallModal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeWaterfallModal()">&times;</span>
            <h2>ç€‘å¸ƒå›¾å¯è§†åŒ–</h2>
            <div id="waterfallModalContent"></div>
        </div>
    </div>

    <!-- ç«ç„°å›¾æ¨¡æ€æ¡† -->
    <div id="flameModal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeFlameModal()">&times;</span>
            <h2>ç«ç„°å›¾å¯è§†åŒ–</h2>
            <div id="flameModalContent"></div>
        </div>
    </div>



    <script src="https://unpkg.com/mxgraph@4.2.2/javascript/mxClient.min.js"></script>
    <script>
        const API_BASE = '/ai-analysis/api/trace-visualization';
        
        // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯ - ç”¨äºå¤„ç†æœ€è¿‘é“¾è·¯åˆ—è¡¨æ•°æ®
        function updateStats(traces) {
            const traceCount = traces.length;
            const serviceSet = new Set();
            let errorCount = 0;
            let totalDuration = 0;

            traces.forEach(trace => {
                if (Array.isArray(trace.services)) {
                    trace.services.forEach(service => serviceSet.add(service));
                }
                if (trace.error_count > 0) errorCount++;
                totalDuration += trace.duration_ms || 0;
            });

            document.getElementById('trace-count').textContent = traceCount;
            document.getElementById('service-count').textContent = serviceSet.size;
            document.getElementById('error-count').textContent = errorCount;
            document.getElementById('avg-duration').textContent = 
                traceCount > 0 ? Math.round(totalDuration / traceCount) : 0;
        }

        // ä½¿ç”¨APIæ•°æ®æ›´æ–°ç»Ÿè®¡ä¿¡æ¯ - ç”¨äºå¤„ç† recent-day æ¥å£è¿”å›çš„ç»Ÿè®¡æ•°æ®
        function updateStatsFromApi(stats) {
            document.getElementById('trace-count').textContent = stats.trace_count || '--';
            document.getElementById('service-count').textContent = stats.service_count || '--';
            document.getElementById('error-count').textContent = stats.error_count || '--';
            document.getElementById('avg-duration').textContent = 
                stats.avg_duration_ms ? Math.round(stats.avg_duration_ms) : '--';
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                // è®¾ç½®åˆå§‹åŠ è½½çŠ¶æ€
                document.getElementById('trace-list').innerHTML = '<div class="loading">æ­£åœ¨åŠ è½½é“¾è·¯æ•°æ®...</div>';
                
                // å¹¶è¡ŒåŠ è½½ä»¥æé«˜æ€§èƒ½
                await Promise.all([
                    loadRecentDayStats(),
                    loadRecentTraces()
                ]);
            } catch (error) {
                console.error('é¡µé¢åˆå§‹åŒ–å¤±è´¥:', error);
                document.getElementById('trace-list').innerHTML = `
                    <div class="error">
                        <p>åˆå§‹åŒ–å¤±è´¥: ${error.message}</p>
                        <button class="btn btn-primary" onclick="retryInit()">é‡è¯•</button>
                    </div>`;
            }
        });

        // é‡è¯•åˆå§‹åŒ–
        async function retryInit() {
            try {
                await Promise.all([
                    loadRecentDayStats(),
                    loadRecentTraces()
                ]);
            } catch (error) {
                console.error('é‡è¯•åˆå§‹åŒ–å¤±è´¥:', error);
            }
        }

        // åŠ è½½æœ€è¿‘é“¾è·¯
        let loadingTimeout;
        async function loadRecentTraces() {
            try {
                const traceList = document.getElementById('trace-list');
                traceList.innerHTML = '<div class="loading">æ­£åœ¨åŠ è½½é“¾è·¯æ•°æ®...</div>';
                
                // å¦‚æœ10ç§’åè¿˜æ²¡æœ‰å“åº”ï¼Œæ˜¾ç¤ºæç¤º
                loadingTimeout = setTimeout(() => {
                    traceList.innerHTML = `
                        <div class="loading">
                            <p>ä»åœ¨åŠ è½½ä¸­ï¼Œè¯·è€å¿ƒç­‰å¾…...</p>
                            <p>é¦–æ¬¡åŠ è½½å¯èƒ½éœ€è¦è¾ƒé•¿æ—¶é—´ã€‚</p>
                            <button class="btn btn-warning" onclick="loadRecentTraces()">é‡è¯•</button>
                        </div>`;
                }, 10000);
                
                const response = await fetch(`${API_BASE}/traces/recent-18`);
                
                // æ¸…é™¤è¶…æ—¶æç¤º
                clearTimeout(loadingTimeout);
                
                if (!response.ok) {
                    throw new Error(`è¯·æ±‚å¤±è´¥ (${response.status}): ${response.statusText}`);
                }
                
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    const text = await response.text();
                    throw new Error(`é¢„æœŸè¿”å›JSONä½†æ”¶åˆ° ${contentType}ã€‚å“åº”å†…å®¹: ${text.substring(0, 200)}`);
                }
                
                const data = await response.json();
                
                if (data.status === 'success') {
                    displayTraces(data.traces);
                    // ç§»é™¤è¿™è¡Œï¼Œé¿å…è¦†ç›–ç³»ç»Ÿæ¦‚è§ˆæ•°æ®
                    // updateStats(data.traces);
                    
                    // æ˜¾ç¤ºæŸ¥è¯¢æ€§èƒ½ä¿¡æ¯
                    if (data.queryTime) {
                        console.log(`æŸ¥è¯¢è€—æ—¶: ${data.queryTime}ms`);
                        if (data.queryTime > 5000) {
                            console.warn('æŸ¥è¯¢è€—æ—¶è¾ƒé•¿ï¼Œå¯èƒ½éœ€è¦ä¼˜åŒ–');
                        }
                    }
                } else {
                    throw new Error(data.message || 'æ•°æ®åŠ è½½å¤±è´¥');
                }
            } catch (error) {
                clearTimeout(loadingTimeout);
                console.error('åŠ è½½é“¾è·¯å¤±è´¥:', error);
                document.getElementById('trace-list').innerHTML = `
                    <div class="error">
                        <p>åŠ è½½é“¾è·¯å¤±è´¥: ${error.message}</p>
                        <p>è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥å¹¶é‡è¯•</p>
                        <button class="btn btn-primary" onclick="loadRecentTraces()">é‡è¯•</button>
                    </div>`;
            }
        }

        // æ˜¾ç¤ºé“¾è·¯åˆ—è¡¨
        function displayTraces(traces) {
            const traceList = document.getElementById('trace-list');
            
            if (traces.length === 0) {
                traceList.innerHTML = '<div class="loading">æš‚æ— é“¾è·¯æ•°æ®</div>';
                return;
            }

            traceList.innerHTML = traces.map(trace => `
                <div class="trace-item" onclick="selectTrace('${trace.trace_id}')">
                    <div class="trace-id">TraceID: ${trace.trace_id}</div>
                    <div class="trace-info">
                        <span><strong>${trace.span_count}</strong> spans</span>
                        <span><strong>${trace.duration_ms}</strong>ms</span>
                        ${trace.error_count > 0 ? '<span style="color: #dc3545;">âš ï¸ æœ‰é”™è¯¯</span>' : '<span style="color: #28a745;">âœ… æ­£å¸¸</span>'}
                    </div>
                    <div class="trace-services">
                        æœåŠ¡: ${Array.isArray(trace.services) ? trace.services.join(', ') : trace.services}
                    </div>
                    <div class="buttons">
                        <button class="btn btn-primary" onclick="event.stopPropagation(); showDagModal('${trace.trace_id}')">DAGå›¾</button>
                        <button class="btn btn-success" onclick="event.stopPropagation(); showWaterfallModal('${trace.trace_id}')">ç€‘å¸ƒå›¾</button>
                        <button class="btn btn-warning" onclick="event.stopPropagation(); showFlameModal('${trace.trace_id}')">ç«ç„°å›¾</button>
                        <button class="btn btn-info" onclick="event.stopPropagation(); showTreeModal('${trace.trace_id}')">è°ƒç”¨æ ‘</button>
                    </div>
                </div>
            `).join('');
        }

        // æ‰“å¼€è°ƒç”¨æ ‘æ¨¡æ€æ¡†
        async function showTreeModal(traceId) {
            document.getElementById('treeModalContent').innerHTML = '<div class="loading">æ­£åœ¨ç”Ÿæˆè°ƒç”¨æ ‘...</div>';
            document.getElementById('treeModal').style.display = 'block';
            
            try {
                const response = await fetch(`${API_BASE}/trace/${traceId}/tree`);
                const data = await response.json();
                
                if (data.status === 'success') {
                    // ä¿å­˜å½“å‰çš„XMLæ•°æ®
                    window.currentDrawioXml = data.drawioXml;
                    window.currentTraceId = data.traceId;
                    window.currentVisualizationType = 'tree';
                    
                    // åˆ›å»ºé¢„è§ˆå†…å®¹
                    const modalContent = document.getElementById('treeModalContent');
                    modalContent.innerHTML = `
                        <div class="success">
                            âœ… æˆåŠŸç”Ÿæˆè°ƒç”¨æ ‘å›¾è¡¨ï¼ŒåŒ…å« ${data.spanCount} ä¸ªspan
                        </div>
                        <div class="buttons" style="margin: 15px 0;">
                            <button class="btn btn-primary" onclick="downloadDrawio('${data.traceId}', 'tree')">ä¸‹è½½Draw.ioæ–‡ä»¶</button>
                            <button class="btn btn-success" onclick="openInDrawio()">åœ¨Draw.ioä¸­æ‰“å¼€</button>
                            <button class="btn btn-warning" onclick="showTreeXmlContent()">æŸ¥çœ‹XMLå†…å®¹</button>
                        </div>
                        <div style="margin: 15px 0;">
                            <strong>Trace ID:</strong> ${data.traceId}<br>
                            <strong>ç”Ÿæˆæ—¶é—´:</strong> ${data.timestamp}
                        </div>
                        <textarea id="tree-drawio-xml" style="width: 100%; height: 200px; margin-top: 15px; font-family: monospace; display: none;">${data.drawioXml}</textarea>
                        <iframe id="tree-drawio-iframe" class="modal-iframe"></iframe>
                    `;

                    // è®¾ç½®iframe src
                    const encoded = encodeURIComponent(data.drawioXml);
                    const viewerUrl = `https://viewer.diagrams.net/?lightbox=1&highlight=0000ff&edit=_blank&layers=1&nav=1&title=${data.traceId}_tree#R${encoded}`;
                    document.getElementById('tree-drawio-iframe').src = viewerUrl;
                } else {
                    throw new Error(data.message || 'ç”Ÿæˆå¤±è´¥');
                }
            } catch (error) {
                document.getElementById('treeModalContent').innerHTML = 
                    `<div class="error">ç”Ÿæˆè°ƒç”¨æ ‘å¤±è´¥: ${error.message}</div>`;
            }
        }

        // å…³é—­è°ƒç”¨æ ‘æ¨¡æ€æ¡†
        function closeTreeModal() {
            document.getElementById('treeModal').style.display = 'none';
            // æ¸…ç†iframeå†…å®¹ï¼Œé¿å…å†…å­˜æ³„æ¼
            const iframe = document.getElementById('tree-drawio-iframe');
            if (iframe) {
                iframe.src = 'about:blank';
            }
        }

        // æ˜¾ç¤º/éšè—è°ƒç”¨æ ‘XMLå†…å®¹
        function showTreeXmlContent() {
            const textarea = document.getElementById('tree-drawio-xml');
            textarea.style.display = textarea.style.display === 'none' ? 'block' : 'none';
        }

        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        window.onclick = function(event) {
            const modal = document.getElementById('treeModal');
            if (event.target === modal) {
                closeTreeModal();
            }
        }

        // æ˜¾ç¤ºXMLå†…å®¹å‡½æ•°
        function showXmlContent(prefix) {
            const xmlElement = document.getElementById(`${prefix}-drawio-xml`);
            xmlElement.style.display = xmlElement.style.display === 'none' ? 'block' : 'none';
        }

        // é€šç”¨ä¸‹è½½ Draw.io æ–‡ä»¶å‡½æ•°
        function downloadDrawio(traceId, type) {
            if (!window.currentDrawioXml) return;
            
            const blob = new Blob([window.currentDrawioXml], { type: 'application/xml' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${traceId}_${type}.drawio`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // åœ¨ Draw.io ä¸­æ‰“å¼€å‡½æ•°
        function openInDrawio() {
            if (!window.currentDrawioXml) return;
            
            const encoded = encodeURIComponent(window.currentDrawioXml);
            const url = `https://app.diagrams.net/?src=about#R${encoded}`;
            window.open(url, '_blank');
        }

        // DAGå›¾æ¨¡æ€æ¡†å‡½æ•°
        async function showDagModal(traceId) {
            document.getElementById('dagModalContent').innerHTML = '<div class="loading">æ­£åœ¨ç”ŸæˆDAGå›¾...</div>';
            document.getElementById('dagModal').style.display = 'block';
            
            try {
                const response = await fetch(`${API_BASE}/trace/${traceId}/dag`);
                const data = await response.json();
                
                if (data.status === 'success') {
                    window.currentDrawioXml = data.drawioXml;
                    window.currentTraceId = data.traceId;
                    window.currentVisualizationType = 'dag';
                    
                    const modalContent = document.getElementById('dagModalContent');
                    modalContent.innerHTML = `
                        <div class="success">
                            âœ… æˆåŠŸç”ŸæˆDAGå›¾è¡¨ï¼ŒåŒ…å« ${data.spanCount} ä¸ªspan
                        </div>
                        <div class="buttons" style="margin: 15px 0;">
                            <button class="btn btn-primary" onclick="downloadDrawio('${data.traceId}', 'dag')">ä¸‹è½½Draw.ioæ–‡ä»¶</button>
                            <button class="btn btn-success" onclick="openInDrawio()">åœ¨Draw.ioä¸­æ‰“å¼€</button>
                            <button class="btn btn-warning" onclick="showDagXmlContent()">æŸ¥çœ‹XMLå†…å®¹</button>
                        </div>
                        <div style="margin: 15px 0;">
                            <strong>Trace ID:</strong> ${data.traceId}<br>
                            <strong>ç”Ÿæˆæ—¶é—´:</strong> ${data.timestamp}
                        </div>
                        <textarea id="dag-drawio-xml" style="width: 100%; height: 200px; margin-top: 15px; font-family: monospace; display: none;">${data.drawioXml}</textarea>
                        <iframe id="dag-drawio-iframe" class="modal-iframe"></iframe>
                    `;

                    const encoded = encodeURIComponent(data.drawioXml);
                    const viewerUrl = `https://viewer.diagrams.net/?lightbox=1&highlight=0000ff&edit=_blank&layers=1&nav=1&title=${data.traceId}_dag#R${encoded}`;
                    document.getElementById('dag-drawio-iframe').src = viewerUrl;
                } else {
                    throw new Error(data.message || 'ç”Ÿæˆå¤±è´¥');
                }
            } catch (error) {
                document.getElementById('dagModalContent').innerHTML = 
                    `<div class="error">ç”ŸæˆDAGå›¾å¤±è´¥: ${error.message}</div>`;
            }
        }

        function closeDagModal() {
            document.getElementById('dagModal').style.display = 'none';
        }

        function showDagXmlContent() {
            showXmlContent('dag');
        }

        // ç€‘å¸ƒå›¾æ¨¡æ€æ¡†å‡½æ•°
        async function showWaterfallModal(traceId) {
            document.getElementById('waterfallModalContent').innerHTML = '<div class="loading">æ­£åœ¨ç”Ÿæˆç€‘å¸ƒå›¾...</div>';
            document.getElementById('waterfallModal').style.display = 'block';
            
            try {
                const response = await fetch(`${API_BASE}/trace/${traceId}/waterfall`);
                const data = await response.json();
                
                if (data.status === 'success') {
                    window.currentDrawioXml = data.drawioXml;
                    window.currentTraceId = data.traceId;
                    window.currentVisualizationType = 'waterfall';
                    
                    const modalContent = document.getElementById('waterfallModalContent');
                    modalContent.innerHTML = `
                        <div class="success">
                            âœ… æˆåŠŸç”Ÿæˆç€‘å¸ƒå›¾è¡¨ï¼ŒåŒ…å« ${data.spanCount} ä¸ªspan
                        </div>
                        <div class="buttons" style="margin: 15px 0;">
                            <button class="btn btn-primary" onclick="downloadDrawio('${data.traceId}', 'waterfall')">ä¸‹è½½Draw.IOæ–‡ä»¶</button>
                            <button class="btn btn-success" onclick="openInDrawio()">åœ¨Draw.IOä¸­æ‰“å¼€</button>
                            <button class="btn btn-warning" onclick="showWaterfallXmlContent()">æŸ¥çœ‹XMLå†…å®¹</button>
                        </div>
                        <div style="margin: 15px 0;">
                            <strong>Trace ID:</strong> ${data.traceId}<br>
                            <strong>ç”Ÿæˆæ—¶é—´:</strong> ${data.timestamp}
                        </div>
                        <textarea id="waterfall-drawio-xml" style="width: 100%; height: 200px; margin-top: 15px; font-family: monospace; display: none;">${data.drawioXml}</textarea>
                        <iframe id="waterfall-drawio-iframe" class="modal-iframe"></iframe>
                    `;

                    const encoded = encodeURIComponent(data.drawioXml);
                    const viewerUrl = `https://viewer.diagrams.net/?lightbox=1&highlight=0000ff&edit=_blank&layers=1&nav=1&title=${data.traceId}_waterfall#R${encoded}`;
                    document.getElementById('waterfall-drawio-iframe').src = viewerUrl;
                } else {
                    throw new Error(data.message || 'ç”Ÿæˆå¤±è´¥');
                }
            } catch (error) {
                document.getElementById('waterfallModalContent').innerHTML = 
                    `<div class="error">ç”Ÿæˆç€‘å¸ƒå›¾å¤±è´¥: ${error.message}</div>`;
            }
        }

        function closeWaterfallModal() {
            document.getElementById('waterfallModal').style.display = 'none';
        }

        function showWaterfallXmlContent() {
            showXmlContent('waterfall');
        }

        // ç«ç„°å›¾æ¨¡æ€æ¡†å‡½æ•°
        async function showFlameModal(traceId) {
            document.getElementById('flameModalContent').innerHTML = '<div class="loading">æ­£åœ¨ç”Ÿæˆç«ç„°å›¾...</div>';
            document.getElementById('flameModal').style.display = 'block';
            
            try {
                const response = await fetch(`${API_BASE}/trace/${traceId}/flame`);
                const data = await response.json();
                
                if (data.status === 'success') {
                    window.currentDrawioXml = data.drawioXml;
                    window.currentTraceId = data.traceId;
                    window.currentVisualizationType = 'flame';
                    
                    const modalContent = document.getElementById('flameModalContent');
                    modalContent.innerHTML = `
                        <div class="success">
                            âœ… æˆåŠŸç”Ÿæˆç«ç„°å›¾è¡¨ï¼ŒåŒ…å« ${data.spanCount} ä¸ªspan
                        </div>
                        <div class="buttons" style="margin: 15px 0;">
                            <button class="btn btn-primary" onclick="downloadDrawio('${data.traceId}', 'flame')">ä¸‹è½½Draw.ioæ–‡ä»¶</button>
                            <button class="btn btn-success" onclick="openInDrawio()">åœ¨Draw.ioä¸­æ‰“å¼€</button>
                            <button class="btn btn-warning" onclick="showFlameXmlContent()">æŸ¥çœ‹XMLå†…å®¹</button>
                        </div>
                        <div style="margin: 15px 0;">
                            <strong>Trace ID:</strong> ${data.traceId}<br>
                            <strong>ç”Ÿæˆæ—¶é—´:</strong> ${data.timestamp}
                        </div>
                        <textarea id="flame-drawio-xml" style="width: 100%; height: 200px; margin-top: 15px; font-family: monospace; display: none;">${data.drawioXml}</textarea>
                        <iframe id="flame-drawio-iframe" class="modal-iframe"></iframe>
                    `;

                    const encoded = encodeURIComponent(data.drawioXml);
                    const viewerUrl = `https://viewer.diagrams.net/?lightbox=1&highlight=0000ff&edit=_blank&layers=1&nav=1&title=${data.traceId}_flame#R${encoded}`;
                    document.getElementById('flame-drawio-iframe').src = viewerUrl;
                } else {
                    throw new Error(data.message || 'ç”Ÿæˆå¤±è´¥');
                }
            } catch (error) {
                document.getElementById('flameModalContent').innerHTML = 
                    `<div class="error">ç”Ÿæˆç«ç„°å›¾å¤±è´¥: ${error.message}</div>`;
            }
        }

        function closeFlameModal() {
            document.getElementById('flameModal').style.display = 'none';
        }

        function showFlameXmlContent() {
            showXmlContent('flame');
        }



        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­ - æ›´æ–°å¤„ç†å¤šä¸ªæ¨¡æ€æ¡†
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
                const iframes = event.target.getElementsByTagName('iframe');
                for (let iframe of iframes) {
                    iframe.src = 'about:blank';
                }
            }
        }

        // åŠ è½½æœ€è¿‘ä¸€å¤©çš„ç»Ÿè®¡ä¿¡æ¯
        async function loadRecentDayStats() {
            try {
                // åˆå§‹åŒ–æ˜¾ç¤ºä¸ºåŠ è½½çŠ¶æ€
                const statsElements = ['trace-count', 'service-count', 'error-count', 'avg-duration'];
                statsElements.forEach(id => {
                    document.getElementById(id).textContent = '--';
                });

                const response = await fetch(`${API_BASE}/stats/recent-hour`);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const data = await response.json();
                if (data.status === 'success') {
                    updateStatsFromApi(data.stats);
                } else {
                    throw new Error(data.message || 'åŠ è½½ç»Ÿè®¡ä¿¡æ¯å¤±è´¥');
                }
            } catch (error) {
                console.error('åŠ è½½ç»Ÿè®¡ä¿¡æ¯å¤±è´¥:', error);
                // ä¿æŒæ˜¾ç¤ºä¸º '--' çŠ¶æ€
            }
        }

        // Trace IDæŸ¥è¯¢åŠŸèƒ½
        async function queryTraceById() {
            const traceId = document.getElementById('trace-id-input').value.trim();
            
            if (!traceId) {
                alert('è¯·è¾“å…¥Trace ID');
                return;
            }

            // éªŒè¯trace idæ ¼å¼
            if (!/^[a-f0-9]{32}$/.test(traceId)) {
                alert('è¯·è¾“å…¥æœ‰æ•ˆçš„Trace IDï¼ˆ32ä½åå…­è¿›åˆ¶å­—ç¬¦ä¸²ï¼‰');
                return;
            }

            try {
                // æ˜¾ç¤ºæŸ¥è¯¢ç»“æœåŒºåŸŸ
                const traceList = document.getElementById('trace-list');
                traceList.innerHTML = '<div class="loading">æ­£åœ¨æŸ¥è¯¢Trace ID: ' + traceId + '...</div>';

                // éªŒè¯traceæ˜¯å¦å­˜åœ¨
                const validateResponse = await fetch(`${API_BASE}/api/traces/validate/${traceId}`);
                const validateData = await validateResponse.json();
                
                if (!validateData.exists) {
                    traceList.innerHTML = `
                        <div class="error">
                            <p>Trace ID "${traceId}" ä¸å­˜åœ¨æˆ–ä¸åœ¨æœ€è¿‘ä¸€å¤©çš„æ•°æ®ä¸­</p>
                            <button class="btn btn-primary" onclick="loadRecentTraces()">è¿”å›é“¾è·¯åˆ—è¡¨</button>
                        </div>`;
                    return;
                }

                // è·å–traceè¯¦æƒ…
                const detailsResponse = await fetch(`${API_BASE}/trace/${traceId}/details`);
                const detailsData = await detailsResponse.json();
                
                if (detailsData.status === 'success') {
                    // æ˜¾ç¤ºå•ä¸ªtraceçš„è¯¦ç»†ä¿¡æ¯
                    const trace = {
                        trace_id: traceId,
                        span_count: detailsData.spans.length,
                        duration_ms: detailsData.metadata.totalDuration,
                        error_count: detailsData.metadata.errorCount,
                        services: Array.from(detailsData.metadata.services)
                    };
                    
                    displaySingleTrace(trace);
                } else {
                    throw new Error(detailsData.message || 'è·å–Traceè¯¦æƒ…å¤±è´¥');
                }
            } catch (error) {
                console.error('æŸ¥è¯¢Traceå¤±è´¥:', error);
                document.getElementById('trace-list').innerHTML = `
                    <div class="error">
                        <p>æŸ¥è¯¢Traceå¤±è´¥: ${error.message}</p>
                        <button class="btn btn-primary" onclick="loadRecentTraces()">è¿”å›é“¾è·¯åˆ—è¡¨</button>
                    </div>`;
            }
        }

        // æ˜¾ç¤ºå•ä¸ªtraceçš„è¯¦ç»†ä¿¡æ¯
        function displaySingleTrace(trace) {
            const traceList = document.getElementById('trace-list');
            
            traceList.innerHTML = `
                <div class="trace-item" onclick="selectTrace('${trace.trace_id}')">
                    <div class="trace-id">TraceID: ${trace.trace_id}</div>
                    <div class="trace-info">
                        <span><strong>${trace.span_count}</strong> spans</span>
                        <span><strong>${trace.duration_ms}</strong>ms</span>
                        ${trace.error_count > 0 ? '<span style="color: #dc3545;">âš ï¸ æœ‰é”™è¯¯</span>' : '<span style="color: #28a745;">âœ… æ­£å¸¸</span>'}
                    </div>
                    <div class="trace-services">
                        æœåŠ¡: ${Array.isArray(trace.services) ? trace.services.join(', ') : trace.services}
                    </div>
                    <div class="buttons">
                        <button class="btn btn-primary" onclick="event.stopPropagation(); showDagModal('${trace.trace_id}')">DAGå›¾</button>
                        <button class="btn btn-success" onclick="event.stopPropagation(); showWaterfallModal('${trace.trace_id}')">ç€‘å¸ƒå›¾</button>
                        <button class="btn btn-warning" onclick="event.stopPropagation(); showFlameModal('${trace.trace_id}')">ç«ç„°å›¾</button>
                        <button class="btn btn-info" onclick="event.stopPropagation(); showTreeModal('${trace.trace_id}')">è°ƒç”¨æ ‘</button>
                    </div>
                </div>
                <div style="margin-top: 15px;">
                    <button class="btn btn-secondary" onclick="loadRecentTraces()">è¿”å›é“¾è·¯åˆ—è¡¨</button>
                </div>
            `;
        }

        // æ”¯æŒå›è½¦é”®æŸ¥è¯¢
        document.addEventListener('DOMContentLoaded', function() {
            const traceInput = document.getElementById('trace-id-input');
            if (traceInput) {
                traceInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        queryTraceById();
                    }
                });
            }
        });
    </script>
</body>
</html>
